<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Fee Clearance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; padding: 0; }
            .shadow-lg { box-shadow: none; }
            #view-clearance { display: block !important; }
            #view-student, #view-fee, #view-discount, #view-enrollment { display: none !important; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            #search-container { display: none !important; }
        }
        /* Modal Styles */
        #debug-modal { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-7xl mx-auto container">
        
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 flex flex-col md:flex-row justify-between items-center border-b-4 border-green-600 no-print">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div class="bg-green-600 text-white p-3 rounded-full">
                    <i class="fas fa-university text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Fee Management System</h1>
                    <p class="text-sm text-gray-500">School of Accountancy & Finance</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.print()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-print mr-2"></i> Print Report
                </button>
                <button onclick="resetSystem()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-trash mr-2"></i> Reset System
                </button>
            </div>
        </div>

        <!-- Connection Status Indicator (Detailed Error) -->
        <div id="conn-status" class="hidden mb-4 px-4 py-2 rounded bg-yellow-100 text-yellow-800 text-sm font-bold no-print flex flex-col justify-center items-center border border-yellow-200">
            <!-- Content populated by JS -->
        </div>

        <!-- Debug Modal -->
        <div id="debug-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl h-3/4 flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg text-red-600">Raw Server Response</h3>
                    <button onclick="document.getElementById('debug-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800 text-xl">&times;</button>
                </div>
                <div class="p-4 flex-grow overflow-auto bg-gray-100 font-mono text-xs">
                    <pre id="debug-content" class="whitespace-pre-wrap break-all"></pre>
                </div>
                <div class="p-4 border-t flex justify-end bg-gray-50 rounded-b-lg">
                    <button onclick="document.getElementById('debug-modal').classList.add('hidden')" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Close</button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white rounded-lg shadow-sm mb-6 no-print">
            <nav class="flex flex-col sm:flex-row flex-wrap">
                <button onclick="switchTab('clearance')" id="tab-clearance" class="py-4 px-6 block hover:text-green-600 text-green-600 border-b-2 border-green-600 font-medium w-full sm:w-auto"><i class="fas fa-file-invoice mr-2"></i> Clearance Report</button>
                <button onclick="switchTab('student')" id="tab-student" class="py-4 px-6 block hover:text-green-600 text-gray-500 font-medium w-full sm:w-auto"><i class="fas fa-users-cog mr-2"></i> Student Data</button>
                <button onclick="switchTab('fee')" id="tab-fee" class="py-4 px-6 block hover:text-green-600 text-gray-500 font-medium w-full sm:w-auto"><i class="fas fa-layer-group mr-2"></i> Fee Structure</button>
                <button onclick="switchTab('enrollment')" id="tab-enrollment" class="py-4 px-6 block hover:text-green-600 text-gray-500 font-medium w-full sm:w-auto"><i class="fas fa-book-reader mr-2"></i> Enrollment</button>
                <button onclick="switchTab('discount')" id="tab-discount" class="py-4 px-6 block hover:text-green-600 text-gray-500 font-medium w-full sm:w-auto"><i class="fas fa-tags mr-2"></i> Discounts</button>
            </nav>
        </div>

        <!-- TAB 1: Clearance Report -->
        <div id="view-clearance" class="tab-content block">
            <div id="search-container" class="bg-blue-50 rounded-lg p-4 mb-6 border border-blue-200 no-print flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label class="block text-xs font-bold text-blue-700 uppercase mb-1">Search Student by Reg #</label>
                    <div class="flex gap-2">
                        <input type="text" id="search_reg_input" placeholder="e.g. BSCAF052530040" class="w-full border rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500 font-mono" onkeypress="handleSearchEnter(event)">
                        <button onclick="searchStudentByRegNo()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold transition flex items-center"><i class="fas fa-search mr-2"></i> Search</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-8 min-h-[800px] relative" id="printableArea">
                <div class="absolute top-8 right-8 no-print">
                    <button onclick="window.print()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded shadow flex items-center text-sm"><i class="fas fa-print mr-2"></i> Print Official Report</button>
                </div>
                <div class="text-center mb-8 border-b-2 border-gray-800 pb-4 mt-4">
                    <h2 class="text-2xl font-bold uppercase tracking-wide">The University of Lahore</h2>
                    <h3 class="text-xl font-semibold text-gray-700">School of Accountancy & Finance</h3>
                    <p class="text-sm text-gray-500 mt-1">Student Fee Clearance Report</p>
                </div>
                <div class="grid grid-cols-2 gap-x-8 gap-y-4 mb-6 text-sm">
                    <div class="flex"><span class="font-bold w-32">Reg #:</span><span class="border-b border-gray-400 flex-1 px-2 text-gray-800 font-mono" id="display_reg_no">--</span></div>
                    <div class="flex"><span class="font-bold w-32">Degree Program:</span><span class="border-b border-gray-400 flex-1 px-2 text-gray-800" id="display_degree">--</span></div>
                    <div class="flex"><span class="font-bold w-32">Name:</span><span class="border-b border-gray-400 flex-1 px-2 text-gray-800" id="display_name">--</span></div>
                    <div class="flex"><span class="font-bold w-32">Batch:</span><span class="border-b border-gray-400 flex-1 px-2 text-gray-800" id="display_batch">--</span></div>
                    <div class="flex"><span class="font-bold w-32">Registration Fee:</span><span class="border-b border-gray-400 flex-1 px-2 text-gray-800 font-mono" id="display_base_reg_fee">--</span></div>
                    <div class="flex"><span class="font-bold w-32 text-gray-700">Per Crhr Fee:</span><span class="border-b border-gray-400 flex-1 px-2 text-gray-800 font-mono" id="display_per_cr_fee">--</span></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs md:text-sm text-left border-collapse border border-gray-300">
                        <thead class="bg-gray-100 text-gray-700 font-bold uppercase text-xs">
                            <tr>
                                <th class="border p-2 text-center w-10">Sr</th><th class="border p-2">Session</th><th class="border p-2 text-center w-12">Cr</th><th class="border p-2 text-center w-16">Subjects</th>
                                <th class="border p-2 text-right">Tuition</th><th class="border p-2 text-right">Exam</th><th class="border p-2 text-right">Others</th><th class="border p-2 text-right bg-gray-50">Total</th>
                                <th class="border p-2 text-center w-12">FA%</th><th class="border p-2 text-right">FA Amt</th><th class="border p-2 text-right font-semibold">Net Fee</th>
                                <th class="border p-2 text-right text-green-700">Paid</th><th class="border p-2 text-right text-red-700">Bal</th>
                            </tr>
                        </thead>
                        <tbody id="feeTableBody"><tr><td colspan="13" class="text-center p-4 text-gray-500 italic">No records found.</td></tr></tbody>
                        <tfoot class="bg-gray-50 font-bold text-gray-800" id="tableFooter"></tfoot>
                    </table>
                </div>
                <div class="mt-8 flex justify-end">
                    <div class="w-64 border border-gray-800 p-4 bg-gray-50">
                        <h4 class="font-bold text-center border-b border-gray-400 mb-2 pb-1">Summary</h4>
                        <div class="flex justify-between mb-1"><span>Total Fee:</span><span id="summary_total">0</span></div>
                        <div class="flex justify-between mb-1 text-green-600"><span>Fin. Assist:</span><span id="summary_fa">0</span></div>
                        <div class="flex justify-between mb-1 text-blue-600"><span>Paid (Receipts):</span><span id="summary_paid">0</span></div>
                        <div class="border-t border-gray-400 my-2"></div>
                        <div class="flex justify-between font-bold text-lg text-red-600"><span>Balance:</span><span id="summary_balance">0</span></div>
                    </div>
                </div>
                <div class="absolute bottom-4 left-8 right-8 flex justify-between text-xs text-gray-400 mt-12"><span>Printed: <span id="printDate"></span></span><span>System generated report</span></div>
            </div>
        </div>

        <!-- TAB 2: Student Data -->
        <div id="view-student" class="tab-content hidden">
            <div id="student-dashboard" class="bg-white rounded-lg shadow-lg p-6">
                <!-- Top Toolbar -->
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Student Directory</h2>
                        <p class="text-sm text-gray-500">Manage all student records here</p>
                        <div class="mt-2 text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full inline-block">
                            Total Students: <span id="total_students_count">0</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto items-center">
                        <!-- Search Bar -->
                        <div class="relative w-full sm:w-64">
                            <input type="text" id="student_list_search" placeholder="Search by Reg, Name, Batch..." onkeyup="filterStudents()" class="border border-gray-300 rounded-lg px-4 py-2 pl-10 w-full text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-2 flex-wrap justify-center sm:justify-start">
                            <input type="file" id="student_excel_file" accept=".xlsx, .xls" class="hidden" onchange="handleStudentExcelUpload(event)">
                            <button onclick="document.getElementById('student_excel_file').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center text-sm shadow-sm" title="Import Excel">
                                <i class="fas fa-file-excel mr-1"></i> Import
                            </button>
                            <button onclick="exportStudentsToExcel()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition flex items-center text-sm shadow-sm" title="Export Excel">
                                <i class="fas fa-file-export mr-1"></i> Export
                            </button>
                            <button onclick="showAddForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center text-sm shadow-sm" title="Add Manual">
                                <i class="fas fa-plus mr-1"></i> Add
                            </button>
                            <button onclick="deleteAllStudents()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center text-sm shadow-sm" title="Delete All">
                                <i class="fas fa-trash-alt mr-1"></i> Del All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="upload-progress-container" class="hidden mb-4">
                    <div class="flex justify-between text-xs mb-1 text-gray-600">
                        <span>Processing Upload...</span>
                        <span id="progress-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm text-left border-collapse border-b border-gray-200">
                        <thead class="bg-gray-50 text-gray-700 uppercase text-xs">
                            <tr>
                                <th class="border-b p-3 cursor-pointer hover:bg-gray-100 select-none group" onclick="sortStudentTable('reg_no')">
                                    Reg Number <i class="fas fa-sort ml-1 text-gray-300 group-hover:text-gray-500"></i>
                                </th>
                                <th class="border-b p-3 cursor-pointer hover:bg-gray-100 select-none group" onclick="sortStudentTable('name')">
                                    Name <i class="fas fa-sort ml-1 text-gray-300 group-hover:text-gray-500"></i>
                                </th>
                                <th class="border-b p-3 cursor-pointer hover:bg-gray-100 select-none group" onclick="sortStudentTable('degree')">
                                    Degree <i class="fas fa-sort ml-1 text-gray-300 group-hover:text-gray-500"></i>
                                </th>
                                <th class="border-b p-3 cursor-pointer hover:bg-gray-100 select-none group" onclick="sortStudentTable('batch')">
                                    Batch <i class="fas fa-sort ml-1 text-gray-300 group-hover:text-gray-500"></i>
                                </th>
                                <th class="border-b p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody"><tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="student-form-container" class="hidden bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto mt-4">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-lg font-bold text-gray-800" id="form-title">Add New Student</h3>
                    <button onclick="hideAddForm()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
                <form id="studentForm" onsubmit="saveStudentList(event)" class="space-y-4">
                    <input type="hidden" id="edit_index" value="-1">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Registration Number</label><input type="text" name="reg_no" id="input_reg_no" oninput="autoFillDegree(this.value)" required class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                        <div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input type="text" name="name" id="input_name" required class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Degree Program</label><input type="text" name="degree" id="input_degree" class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Batch (Session)</label><input type="text" name="batch" id="input_batch" class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                        <div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label><input type="text" name="mobile" id="input_mobile" class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                        <div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" name="email" id="input_email" class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                    </div>
                    <div class="pt-4 flex gap-2"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Save Student</button><button type="button" onclick="hideAddForm()" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg">Cancel</button></div>
                </form>
            </div>
        </div>

        <!-- TAB 3: Fee Record -->
        <div id="view-fee" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-4xl mx-auto">
                <div class="flex items-center gap-3 mb-6 border-b pb-4">
                    <div class="bg-green-100 text-green-600 p-3 rounded-full"><i class="fas fa-layer-group text-xl"></i></div>
                    <div><h2 class="text-xl font-bold text-gray-800">Fee Structure</h2><p class="text-sm text-gray-500">Define fee records by Degree & Batch.</p></div>
                </div>
                <form id="feeForm" onsubmit="addRecord(event)" class="space-y-6">
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h3 class="text-sm font-bold text-yellow-800 uppercase mb-3">1. Target Cohort</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Degree Program</label><select name="target_degree" id="fee_degree_select" class="w-full border border-yellow-400 rounded px-3 py-2 bg-white mt-1" required><option value="">Select Degree...</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Batch</label><select name="target_batch" id="fee_batch_select" class="w-full border border-yellow-400 rounded px-3 py-2 bg-white mt-1" required><option value="">Select Batch...</option></select></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 uppercase mb-3">2. Academic Session</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Year</label><select name="year" class="w-full border rounded px-3 py-2 bg-white mt-1"><option value="2023">2023</option><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Semester</label><select name="semester" class="w-full border rounded px-3 py-2 bg-white mt-1"><option value="Winter">Winter</option><option value="Spring">Spring</option><option value="Summer">Summer</option><option value="Fall">Fall</option></select></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 uppercase mb-3">3. Credit Hour & Tuition Fee</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Total Credit Hrs</label><input type="number" name="cr" id="cr_input" oninput="calculateTotals()" class="w-full border rounded px-3 py-2 mt-1" placeholder="0"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase text-green-700">Cost Per Cr. Hour</label><input type="number" name="per_cr_fee" id="rate_input" oninput="calculateTotals()" class="w-full border border-green-300 bg-green-50 rounded px-3 py-2 mt-1" placeholder="0"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Tuition Fee</label><input type="number" name="tuition_fee" id="tuition_input" class="w-full border rounded px-3 py-2 bg-gray-100 mt-1 font-bold text-gray-700" placeholder="0" readonly></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 uppercase mb-3">4. Examination Fee</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Total Courses</label><input type="number" name="total_courses" id="courses_input" oninput="calculateTotals()" class="w-full border rounded px-3 py-2 mt-1" placeholder="0"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase text-blue-700">Exam Fee (Per Subject)</label><input type="number" name="exam_fee_per_subject" id="exam_rate_input" oninput="calculateTotals()" class="w-full border border-blue-300 bg-blue-50 rounded px-3 py-2 mt-1" placeholder="0"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Total Exam Fee</label><input type="number" name="exam_fee" id="total_exam_input" class="w-full border rounded px-3 py-2 bg-gray-100 mt-1 font-bold text-gray-700" placeholder="0" readonly></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 uppercase mb-3">5. Other Charges & Payments</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Registration Fee</label><input type="number" name="reg_fee" class="w-full border rounded px-3 py-2 mt-1" placeholder="0"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Other Charges</label><input type="number" name="other_fee" class="w-full border rounded px-3 py-2 mt-1" placeholder="0"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Total Paid</label><input type="number" name="paid" class="w-full border rounded px-3 py-2 mt-1" placeholder="0"></div>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md"><i class="fas fa-plus-circle mr-2"></i> Add Batch Fee Record</button>
                </form>
                <div class="mt-8 border-t pt-4">
                    <h4 class="text-gray-700 text-lg font-bold mb-4">Fee Record Dashboard</h4>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left border-collapse border border-gray-200"><thead class="bg-gray-100 text-gray-700 uppercase text-xs"><tr><th class="border p-2">Degree Program</th><th class="border p-2">Batch</th><th class="border p-2 text-right">Per Cr. Fee</th><th class="border p-2 text-right">Total Exam Fee</th><th class="border p-2 text-right">Others</th><th class="border p-2 text-right">Total Semester Fee</th><th class="border p-2 text-center">Session</th></tr></thead><tbody id="feeDashboardBody"><tr><td colspan="7" class="p-4 text-center text-gray-500 italic">Loading...</td></tr></tbody></table></div>
                </div>
            </div>
        </div>

        <!-- TAB 4: Enrollment -->
        <div id="view-enrollment" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4 border-b pb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Enrollment Data</h2><p class="text-sm text-gray-500 mb-2">Upload Excel (Reg #, Name, Courses, Credit Hrs).</p>
                        <div class="bg-orange-50 p-2 rounded border border-orange-200"><label class="block text-xs font-bold text-orange-700 uppercase mb-1">Target Session for Import:</label><div class="flex gap-2"><select id="enroll_import_year" class="border rounded px-2 py-1 text-sm bg-white"><option value="" disabled selected>Year</option><option value="2023">2023</option><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option></select><select id="enroll_import_sem" class="border rounded px-2 py-1 text-sm bg-white"><option value="" disabled selected>Semester</option><option value="Winter">Winter</option><option value="Spring">Spring</option><option value="Summer">Summer</option><option value="Fall">Fall</option></select></div></div>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="enrollment_excel_file" accept=".xlsx, .xls" class="hidden" onchange="handleEnrollmentExcelUpload(event)">
                        <button onclick="document.getElementById('enrollment_excel_file').click()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition flex items-center text-sm shadow-md"><i class="fas fa-file-import mr-2"></i> Import Enrollment</button>
                        <button onclick="downloadEnrollmentTemplate()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition flex items-center text-sm"><i class="fas fa-download mr-2"></i> Template</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                    <table class="w-full text-sm text-left border-collapse border border-gray-200"><thead class="bg-orange-50 text-gray-700 uppercase text-xs sticky top-0"><tr><th class="border p-3">Reg Number</th><th class="border p-3">Name</th><th class="border p-3">Semester</th><th class="border p-3 text-center">Courses</th><th class="border p-3 text-center">Credit Hours</th></tr></thead><tbody id="enrollmentTableBody"><tr><td colspan="5" class="p-4 text-center text-gray-500 italic">Loading...</td></tr></tbody></table>
                </div>
            </div>
        </div>

        <!-- TAB 5: Discounts -->
        <div id="view-discount" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b pb-4">
                    <div><h2 class="text-xl font-bold text-gray-800">Discount Registry</h2><p class="text-sm text-gray-500">Upload Excel with Reg Number, Name, Academic Term, Student Discount</p></div>
                    <div class="flex gap-2">
                        <input type="file" id="discount_excel_file" accept=".xlsx, .xls" class="hidden" onchange="handleDiscountExcelUpload(event)">
                        <button onclick="document.getElementById('discount_excel_file').click()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center text-sm"><i class="fas fa-file-import mr-2"></i> Import Discounts</button>
                        <button onclick="downloadDiscountTemplate()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition flex items-center text-sm"><i class="fas fa-download mr-2"></i> Template</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                    <table class="w-full text-sm text-left border-collapse border border-gray-200"><thead class="bg-purple-50 text-gray-700 uppercase text-xs sticky top-0"><tr><th class="border p-3">Reg Number</th><th class="border p-3">Name</th><th class="border p-3">Academic Term</th><th class="border p-3 text-right">Discount %</th></tr></thead><tbody id="discountTableBody"><tr><td colspan="4" class="p-4 text-center text-gray-500 italic">Loading...</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- API & DATA CONFIG ---
        const API_URL = 'api.php'; 
        let USE_API = true; 

        let g_students = [];
        let g_fees = [];
        let g_enrollments = [];
        let g_discounts = [];
        let activeStudent = null;
        let lastRawResponse = '';
        let sortDir = 1;

        // --- EDIT HERE TO ADD/REMOVE DEGREES ---
        const DEGREE_PATTERNS = [
            { prefix: "BAF0", code: "BAF" },
            { prefix: "BCOM0", code: "BCOM" },
            { prefix: "BAF2Y0", code: "BAF2Y" },
            { prefix: "BSCAF0", code: "BSCAF" },
            { prefix: "MSFP0", code: "MSFP" },
            { prefix: "MAF2Y0", code: "MAF2Y" },
            { prefix: "DAF0", code: "DAF" },
            { prefix: "BCM0", code: "BCM" },
            { prefix: "BST0", code: "BST" },
            { prefix: "BIB0", code: "BIB" },
            { prefix: "PAF0", code: "PAF" }, // Added PAF here
            // Add new line here: { prefix: "XYZ", code: "XYZ_DEGREE" },
        ];

        // --- INIT ---
        document.getElementById('printDate').textContent = new Date().toLocaleString();
        initData();

        async function initData() {
            try {
                const res = await fetch(`${API_URL}?action=fetch_all`);
                const text = await res.text();
                lastRawResponse = text; 

                let json;
                try {
                    json = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Invalid JSON received. Response start: "${text.substring(0, 150)}..."`); 
                }
                
                if (json.status === 'success') {
                    USE_API = true;
                    g_students = json.data.students || [];
                    g_fees = json.data.fees || [];
                    g_enrollments = json.data.enrollments || [];
                    g_discounts = json.data.discounts || [];
                    document.getElementById('conn-status').classList.add('hidden');
                } else {
                    throw new Error(json.message || 'Unknown API error');
                }
            } catch (e) {
                console.warn("API Error:", e);
                USE_API = false;
                
                const statusDiv = document.getElementById('conn-status');
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = `
                    <div class="flex justify-between w-full items-center">
                        <div class="flex flex-col">
                            <span class="text-red-700"><strong>Connection Error:</strong> ${e.message}</span>
                            <span class="text-xs mt-1 opacity-75">(Switched to Local Storage Mode)</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showDebugModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs">View Raw Error</button>
                            <button onclick="this.parentElement.parentElement.parentElement.classList.add('hidden')" class="font-bold hover:text-red-700 text-xl">&times;</button>
                        </div>
                    </div>
                `;

                g_students = getStorage('fee_system_students_list_v2');
                g_fees = getStorage('fee_system_records_v6');
                g_enrollments = getStorage('fee_system_enrollments_v1');
                g_discounts = getStorage('fee_system_discounts_v1');
            }
            renderStudentTable(); renderFeeDashboard(); renderEnrollmentTable(); renderDiscountTable();
            const saved = localStorage.getItem('active_student_session');
            if (saved) { activeStudent = JSON.parse(saved); loadActiveStudentUI(); renderClearanceTable(); }
        }

        function showDebugModal() {
            document.getElementById('debug-content').textContent = lastRawResponse || "No response recorded.";
            document.getElementById('debug-modal').classList.remove('hidden');
        }

        // --- DATA OPS ---
        async function saveData(type, data) {
            if (USE_API) {
                let act = (type === 'student') ? 'save_student' : 'save_fee';
                const res = await fetch(`${API_URL}?action=${act}`, { method: 'POST', body: JSON.stringify(data) });
                return await res.json();
            } else {
                if (type === 'student') { g_students.push(data); setStorage('fee_system_students_list_v2', g_students); }
                else if (type === 'fee') { g_fees.push(data); setStorage('fee_system_records_v6', g_fees); }
                return { status: 'success' };
            }
        }

        async function deleteStudentData(regNo) {
            if (USE_API) {
                await fetch(`${API_URL}?action=delete_student`, { method: 'POST', body: JSON.stringify({reg_no: regNo}) });
                await initData();
            } else {
                g_students = g_students.filter(s => s.reg_no !== regNo);
                setStorage('fee_system_students_list_v2', g_students);
                renderStudentTable();
            }
        }

        async function deleteAllStudentsData() {
            if (USE_API) {
                await fetch(`${API_URL}?action=delete_all_students`, { method: 'POST' });
                await initData();
            } else {
                g_students = [];
                setStorage('fee_system_students_list_v2', []);
                renderStudentTable();
            }
        }

        async function bulkImport(type, arr) {
            if (USE_API) {
                let act = '';
                if(type==='students') act='import_students';
                if(type==='enrollments') act='import_enrollments';
                if(type==='discounts') act='import_discounts';
                const res = await fetch(`${API_URL}?action=${act}`, { method: 'POST', body: JSON.stringify(arr) });
                const r = await res.json();
                if(r.status==='success') await initData();
                return r;
            } else {
                if(type==='students') { g_students=[...g_students,...arr]; setStorage('fee_system_students_list_v2', g_students); }
                if(type==='enrollments') { g_enrollments=[...g_enrollments,...arr]; setStorage('fee_system_enrollments_v1', g_enrollments); }
                if(type==='discounts') { g_discounts=[...g_discounts,...arr]; setStorage('fee_system_discounts_v1', g_discounts); }
                renderStudentTable(); renderEnrollmentTable(); renderDiscountTable();
                return { status: 'success' };
            }
        }

        // --- STUDENT UI ---
        function showAddForm() { 
            document.getElementById('studentForm').reset();
            document.getElementById('edit_index').value = "-1";
            document.getElementById('form-title').textContent = "Add New Student";
            document.getElementById('student-dashboard').classList.add('hidden'); 
            document.getElementById('student-form-container').classList.remove('hidden'); 
        }
        function hideAddForm() { document.getElementById('student-dashboard').classList.remove('hidden'); document.getElementById('student-form-container').classList.add('hidden'); }
        
        // --- NEW AUTO-DEGREE LOGIC ---
        function extractDegree(reg) {
            if(!reg) return '';
            reg = reg.toString().toUpperCase().trim();
            
            for (const item of DEGREE_PATTERNS) {
                if (reg.startsWith(item.prefix)) {
                    return item.code;
                }
            }
            return "Unknown";
        }
        
        function autoFillDegree(val) {
            const degree = extractDegree(val);
            if(degree && degree !== "Unknown") {
                document.getElementById('input_degree').value = degree;
            }
        }

        async function saveStudentList(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const reg = fd.get('reg_no').trim(); // Ensure trim
            
            if(document.getElementById('edit_index').value === "-1") {
                if(g_students.some(s => s.reg_no.toLowerCase() === reg.toLowerCase())) {
                    alert("Student with this Registration Number already exists!");
                    return;
                }
            }

            const student = {
                reg_no: reg, name: fd.get('name'),
                degree: fd.get('degree') || extractDegree(reg), // Use field or auto-calc
                batch: fd.get('batch'), mobile: fd.get('mobile'), email: fd.get('email')
            };
            
            const res = await saveData('student', student);
            if(res.status === 'success') {
                if(USE_API) await initData(); else renderStudentTable();
                hideAddForm();
                alert("Student saved!");
            }
        }

        function editStudent(reg) {
            const s = g_students.find(x => x.reg_no === reg);
            if(!s) return;
            document.getElementById('input_reg_no').value = s.reg_no;
            document.getElementById('input_name').value = s.name;
            document.getElementById('input_degree').value = s.degree;
            document.getElementById('input_batch').value = s.batch;
            document.getElementById('input_mobile').value = s.mobile;
            document.getElementById('input_email').value = s.email || '';
            document.getElementById('edit_index').value = "1"; // Editing mode
            document.getElementById('form-title').textContent = "Edit Student";
            document.getElementById('student-dashboard').classList.add('hidden'); 
            document.getElementById('student-form-container').classList.remove('hidden'); 
        }

        function deleteStudent(reg) {
            if(confirm('Are you sure you want to delete this student?')) {
                deleteStudentData(reg);
            }
        }

        function deleteAllStudents() {
            if(confirm('WARNING: Are you sure you want to delete ALL students? This cannot be undone.')) {
                deleteAllStudentsData();
            }
        }

        function exportStudentsToExcel() {
            if(g_students.length === 0) { alert("No students to export."); return; }
            const ws = XLSX.utils.json_to_sheet(g_students);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Students");
            XLSX.writeFile(wb, "All_Students.xlsx");
        }

        function handleStudentExcelUpload(e) { 
            const f = e.target.files[0];
            if(!f) return;
            
            // Show Progress
            document.getElementById('upload-progress-container').classList.remove('hidden');
            const pBar = document.getElementById('upload-progress-bar');
            const pText = document.getElementById('progress-text');
            pBar.style.width = '30%';
            pText.textContent = 'Parsing...';

            const r = new FileReader();
            r.onload = async function(ev) {
                try {
                    const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    
                    let newStudents = [];
                    let duplicates = 0;

                    pBar.style.width = '60%';
                    pText.textContent = 'Checking Duplicates...';

                    // Simulate slight delay for UI update
                    await new Promise(r => setTimeout(r, 100));

                    json.forEach(row => {
                        const keys = Object.keys(row);
                        const getKey = (term) => keys.find(k => k.toLowerCase().includes(term));
                        const reg = row[getKey('reg')] || row[getKey('id')];
                        
                        if (reg) {
                            if(!g_students.some(s => s.reg_no.trim().toLowerCase() === reg.toString().trim().toLowerCase())) {
                                const extractedDeg = extractDegree(reg.toString());
                                newStudents.push({
                                    reg_no: reg,
                                    name: row[getKey('name')] || '',
                                    // Use degree from excel OR auto-calculate from Reg No
                                    degree: row[getKey('degree')] || row[getKey('prog')] || extractedDeg,
                                    batch: row[getKey('session')] || row[getKey('batch')] || '',
                                    mobile: row[getKey('mobile')] || row[getKey('phone')] || '',
                                    email: row[getKey('email')] || ''
                                });
                            } else {
                                duplicates++;
                            }
                        }
                    });

                    if(newStudents.length > 0) {
                        pBar.style.width = '90%';
                        pText.textContent = 'Saving...';
                        const res = await bulkImport('students', newStudents);
                        if(res.status === 'success') {
                            pBar.style.width = '100%';
                            pText.textContent = 'Done!';
                            setTimeout(() => {
                                alert(`Imported ${newStudents.length} new students.\nSkipped ${duplicates} duplicates.`);
                                document.getElementById('upload-progress-container').classList.add('hidden');
                                pBar.style.width = '0%';
                            }, 500);
                        }
                    } else {
                        pBar.style.width = '100%';
                        pText.textContent = 'Done!';
                        setTimeout(() => {
                            alert(`No new students found.\nSkipped ${duplicates} duplicates.`);
                            document.getElementById('upload-progress-container').classList.add('hidden');
                            pBar.style.width = '0%';
                        }, 500);
                    }
                } catch(err) { 
                    console.error(err); 
                    alert("Error parsing Excel."); 
                    document.getElementById('upload-progress-container').classList.add('hidden');
                }
            };
            r.readAsArrayBuffer(f);
            e.target.value = '';
        }

        // --- CLEARANCE LOGIC ---
        function searchStudentByRegNo() {
            const regNo = document.getElementById('search_reg_input').value.trim();
            if (!regNo) { alert("Please enter a registration number."); return; }
            const student = g_students.find(s => s.reg_no.toLowerCase() === regNo.toLowerCase());
            if (student) {
                activeStudent = student;
                localStorage.setItem('active_student_session', JSON.stringify(student));
                loadActiveStudentUI(); renderClearanceTable();
                document.getElementById('search_reg_input').value = ''; 
            } else { alert("Student not found!"); }
        }

        function loadActiveStudentUI() {
            const s = activeStudent;
            const ids = ['display_reg_no', 'display_name', 'display_degree', 'display_batch', 'display_per_cr_fee', 'display_base_reg_fee'];
            if(!s) { ids.forEach(id => document.getElementById(id).textContent = '--'); return; }
            document.getElementById('display_reg_no').textContent = s.reg_no;
            document.getElementById('display_name').textContent = s.name;
            document.getElementById('display_degree').textContent = s.degree;
            document.getElementById('display_batch').textContent = s.batch;
            
            const baseRec = findBaseFeeRecord(s.degree, s.batch);
            document.getElementById('display_per_cr_fee').textContent = baseRec ? num(baseRec.per_cr_fee) : '--';
            document.getElementById('display_base_reg_fee').textContent = baseRec ? num(baseRec.reg_fee) : '--';
        }

        function findBaseFeeRecord(degree, batch) {
            if(!degree || !batch) return null;
            const normD = degree.trim().toLowerCase();
            const normB = batch.trim().toLowerCase();
            const matches = g_fees.filter(r => (r.degree||"").trim().toLowerCase() === normD && (r.batch||"").trim().toLowerCase() === normB);
            const normBatchStr = normalizeTerm(batch);
            let found = matches.find(r => normalizeTerm(`${r.semester} ${r.year}`) === normBatchStr);
            if (!found && matches.length > 0) {
                found = matches.sort((a,b) => {
                    if (a.year !== b.year) return a.year - b.year;
                    const semOrder = { 'winter': 1, 'spring': 2, 'summer': 3, 'fall': 4 };
                    return (semOrder[(a.semester||"").toLowerCase()] || 0) - (semOrder[(b.semester||"").toLowerCase()] || 0);
                })[0];
            }
            return found;
        }

        function renderClearanceTable() {
            const tbody = document.getElementById('feeTableBody');
            if (!activeStudent) return;
            const s = activeStudent;
            const baseRec = findBaseFeeRecord(s.degree, s.batch);
            const myEnrollments = g_enrollments.filter(e => e.reg_no === s.reg_no);
            const myFeeStructure = g_fees.filter(r => (r.degree||"").trim().toLowerCase() === (s.degree||"").trim().toLowerCase() && (r.batch||"").trim().toLowerCase() === (s.batch||"").trim().toLowerCase());

            const terms = {};
            myFeeStructure.forEach(r => { const k = normalizeTerm(`${r.semester} ${r.year}`); if(!terms[k]) terms[k] = { key: k, year: r.year, sem: r.semester, master: r, enroll: null }; else terms[k].master = r; });
            myEnrollments.forEach(e => {
                const k = normalizeTerm(e.semester);
                const parts = e.semester.split(' ');
                if(!terms[k]) terms[k] = { key: k, year: parts[1]||"", sem: parts[0]||"", master: null, enroll: e }; else terms[k].enroll = e;
            });

            const merged = Object.values(terms).sort((a,b) => {
                if(a.year != b.year) return a.year - b.year;
                const so = { 'winter': 1, 'spring': 2, 'summer': 3, 'fall': 4 };
                return (so[(a.sem||"").toLowerCase()] || 0) - (so[(b.sem||"").toLowerCase()] || 0);
            });

            let html = '';
            let totals = { tuition: 0, exam: 0, other: 0, total: 0, fa: 0, net: 0, paid: 0, bal: 0 };

            if(merged.length === 0) { tbody.innerHTML = `<tr><td colspan="13" class="text-center p-4 text-gray-500 italic">No data found.</td></tr>`; updateSummary(0,0,0,0); return; }

            merged.forEach((item, idx) => {
                const m = item.master || {}; 
                const e = item.enroll || {}; 
                const rateSource = item.master ? item.master : (baseRec || {});

                let cr = 0, sub = 0;
                if(item.enroll) { cr = parseInt(e.cr)||0; sub = parseInt(e.courses)||0; }
                else if(item.master) { cr = parseInt(m.cr)||0; sub = parseInt(m.total_courses)||0; }
                else if(baseRec) { cr = parseInt(baseRec.cr)||0; sub = parseInt(baseRec.total_courses)||0; }

                const rateCr = parseFloat(rateSource.per_cr_fee) || 0;
                const rateExam = parseFloat(rateSource.exam_fee_per_subject) || 0;
                const other = parseFloat(rateSource.other_fee) || 0;
                
                const tui = cr * rateCr;
                const ex = sub * rateExam;
                const rowTotal = tui + ex + other; // No Reg Fee here

                const dRec = g_discounts.find(d => d.reg_no === s.reg_no && normalizeTerm(d.term) === item.key);
                const dPct = dRec ? parseFloat(dRec.discount) : 0;
                const faAmt = Math.round(rowTotal * (dPct / 100));
                const net = rowTotal - faAmt;
                const pd = parseFloat(m.paid) || 0; 
                const bal = net - pd;

                totals.tuition += tui; totals.exam += ex; totals.other += other;
                totals.total += rowTotal; totals.fa += faAmt; totals.net += net; totals.paid += pd; totals.bal += bal;

                const rowCls = (!item.master && !!baseRec) ? "bg-blue-50/30" : "hover:bg-gray-50";
                const srcIcon = (!item.master && !!baseRec) ? `<i class="fas fa-link text-gray-400 text-[10px]" title="Base Rate"></i>` : "";
                const crStyle = item.enroll ? "text-blue-700 font-bold" : "";

                html += `
                <tr class="${rowCls} border-b border-gray-100">
                    <td class="border-r p-2 text-center text-gray-500">${idx+1}</td>
                    <td class="border-r p-2 font-medium">${item.sem}-${item.year} ${srcIcon}</td>
                    <td class="border-r p-2 text-center ${crStyle}">${cr}</td>
                    <td class="border-r p-2 text-center text-gray-600">${sub}</td>
                    <td class="border-r p-2 text-right text-gray-600">${num(tui)}</td>
                    <td class="border-r p-2 text-right text-gray-600">${num(ex)}</td>
                    <td class="border-r p-2 text-right text-gray-600">${num(other)}</td>
                    <td class="border-r p-2 text-right font-semibold bg-gray-50">${num(rowTotal)}</td>
                    <td class="border-r p-2 text-center text-sm">${dPct}%</td>
                    <td class="border-r p-2 text-right text-green-600 text-sm">${num(faAmt)}</td>
                    <td class="border-r p-2 text-right font-bold">${num(net)}</td>
                    <td class="border-r p-2 text-right text-blue-600">${num(pd)}</td>
                    <td class="p-2 text-right ${bal>0?'text-red-600 font-bold':'text-green-600'}">${num(bal)}</td>
                </tr>`;
            });

            tbody.innerHTML = html;
            document.getElementById('tableFooter').innerHTML = `
                <tr class="bg-gray-100 border-t-2 border-gray-300 font-bold">
                    <td colspan="4" class="p-2 text-right">Totals:</td>
                    <td class="p-2 text-right text-xs">${num(totals.tuition)}</td>
                    <td class="p-2 text-right text-xs">${num(totals.exam)}</td>
                    <td class="p-2 text-right text-xs">${num(totals.other)}</td>
                    <td class="p-2 text-right">${num(totals.total)}</td>
                    <td></td>
                    <td class="p-2 text-right text-xs">${num(totals.fa)}</td>
                    <td class="p-2 text-right">${num(totals.net)}</td>
                    <td class="p-2 text-right">${num(totals.paid)}</td>
                    <td class="p-2 text-right">${num(totals.bal)}</td>
                </tr>`;
            updateSummary(totals.total, totals.fa, totals.paid, totals.bal);
        }

        function renderStudentTable(data = g_students) {
            // Update Total Count
            document.getElementById('total_students_count').textContent = data.length;
            
            const tbody = document.getElementById('studentsTableBody');
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">No students found.</td></tr>'; return; }
            tbody.innerHTML = data.map((s,i) => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-3 font-medium">${s.reg_no}</td><td class="p-3">${s.name}</td>
                    <td class="p-3">${s.degree}</td><td class="p-3">${s.batch}</td>
                    <td class="p-3 text-center space-x-1">
                        <button onclick="loadStudentForSearch('${s.reg_no}')" class="text-green-600 hover:text-green-800" title="Clearance"><i class="fas fa-file-invoice"></i></button>
                        <button onclick="editStudent('${s.reg_no}')" class="text-blue-600 hover:text-blue-800" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteStudent('${s.reg_no}')" class="text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        function filterStudents() {
            const query = document.getElementById('student_list_search').value.toLowerCase();
            const filtered = g_students.filter(s => 
                (s.reg_no && s.reg_no.toLowerCase().includes(query)) ||
                (s.name && s.name.toLowerCase().includes(query)) ||
                (s.degree && s.degree.toLowerCase().includes(query)) ||
                (s.batch && s.batch.toLowerCase().includes(query))
            );
            renderStudentTable(filtered);
        }
        
        function sortStudentTable(key) {
            sortDir = -sortDir; // Toggle direction
            const query = document.getElementById('student_list_search').value.toLowerCase();
            
            // Get current list (either full or filtered)
            let currentList = query ? g_students.filter(s => 
                (s.reg_no && s.reg_no.toLowerCase().includes(query)) ||
                (s.name && s.name.toLowerCase().includes(query))
            ) : [...g_students];

            currentList.sort((a, b) => {
                const valA = (a[key] || '').toString().toLowerCase();
                const valB = (b[key] || '').toString().toLowerCase();
                if (valA < valB) return -1 * sortDir;
                if (valA > valB) return 1 * sortDir;
                return 0;
            });
            
            renderStudentTable(currentList);
        }

        // --- GENERIC HELPERS ---
        function loadStudentForSearch(reg) { document.getElementById('search_reg_input').value = reg; switchTab('clearance'); searchStudentByRegNo(); }
        function updateFeeDropdowns() {
            const deg = [...new Set(g_students.map(s=>s.degree).filter(Boolean))].sort();
            const bat = [...new Set(g_students.map(s=>s.batch).filter(Boolean))].sort();
            document.getElementById('fee_degree_select').innerHTML = `<option value="">Select...</option>` + deg.map(x=>`<option>${x}</option>`).join('');
            document.getElementById('fee_batch_select').innerHTML = `<option value="">Select...</option>` + bat.map(x=>`<option>${x}</option>`).join('');
        }
        function updateSummary(t,f,p,b) { document.getElementById('summary_total').textContent = num(t); document.getElementById('summary_fa').textContent = num(f); document.getElementById('summary_paid').textContent = num(p); document.getElementById('summary_balance').textContent = num(b); }
        function handleSearchEnter(e) { if(e.key==='Enter') searchStudentByRegNo(); }
        function switchTab(tabId) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.getElementById('view-'+tabId).classList.remove('hidden'); if(tabId==='fee') updateFeeDropdowns(); }
        function num(n) { return parseFloat(n).toLocaleString('en-US'); }
        function getStorage(k) { const s=localStorage.getItem(k); return s?JSON.parse(s):[]; }
        function setStorage(k,v) { localStorage.setItem(k,JSON.stringify(v)); }
        function resetSystem() { if(confirm("Reset All?")) { if(USE_API) fetch(`${API_URL}?action=reset`).then(()=>location.reload()); else { localStorage.clear(); location.reload(); } } }
        function normalizeTerm(t) { return t ? t.toString().toLowerCase().replace(/[^a-z0-9]/g, '') : ""; }
        
        // --- OTHER RENDERERS ---
        function renderFeeDashboard() { const t=document.getElementById('feeDashboardBody'); if(g_fees.length==0) { t.innerHTML='<tr><td colspan="7" class="p-4 text-center italic">No records.</td></tr>'; return; } t.innerHTML=g_fees.slice().reverse().map(r=>`<tr class="hover:bg-gray-50 border-b"><td class="p-2">${r.degree}</td><td class="p-2">${r.batch}</td><td class="p-2 text-right">${num(r.per_cr_fee)}</td><td class="p-2 text-right">${num(r.exam_fee)}</td><td class="p-2 text-right">${num(r.other_fee)}</td><td class="p-2 text-right font-bold">${num(parseFloat(r.tuition_fee)+parseFloat(r.exam_fee)+parseFloat(r.other_fee)+parseFloat(r.reg_fee))}</td><td class="p-2 text-center text-xs">${r.semester} ${r.year}</td></tr>`).join(''); }
        function renderEnrollmentTable() { const t=document.getElementById('enrollmentTableBody'); if(g_enrollments.length==0) { t.innerHTML='<tr><td colspan="5" class="p-4 text-center italic">No data.</td></tr>'; return; } t.innerHTML=g_enrollments.slice().reverse().map(e=>`<tr class="hover:bg-orange-50 border-b"><td class="p-3">${e.reg_no}</td><td class="p-3">${e.name}</td><td class="p-3 font-bold text-orange-700">${e.semester}</td><td class="p-3 text-center font-bold">${e.courses}</td><td class="p-3 text-center font-bold">${e.cr}</td></tr>`).join(''); }
        function renderDiscountTable() { const t=document.getElementById('discountTableBody'); if(g_discounts.length==0) { t.innerHTML='<tr><td colspan="4" class="p-4 text-center italic">No data.</td></tr>'; return; } t.innerHTML=g_discounts.slice().reverse().map(d=>`<tr class="hover:bg-purple-50 border-b"><td class="p-3">${d.reg_no}</td><td class="p-3">${d.name}</td><td class="p-3">${d.term}</td><td class="p-3 text-right font-bold text-green-600">${d.discount}%</td></tr>`).join(''); }
        
        // --- ADD BATCH FEE ---
        async function addRecord(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const rec = {
                degree: fd.get('target_degree'), batch: fd.get('target_batch'), year: fd.get('year'), semester: fd.get('semester'),
                cr: fd.get('cr'), per_cr_fee: fd.get('per_cr_fee'), tuition_fee: fd.get('tuition_fee'),
                total_courses: fd.get('total_courses'), exam_fee_per_subject: fd.get('exam_fee_per_subject'), exam_fee: fd.get('exam_fee'),
                reg_fee: fd.get('reg_fee'), other_fee: fd.get('other_fee'), paid: fd.get('paid'), total_fee: 0 
            };
            const res = await saveData('fee', rec);
            if(res.status==='success') { if(USE_API) await initData(); else renderFeeDashboard(); alert("Fee record saved!"); e.target.reset(); }
        }
        function calculateTotals() {
            const cr=parseFloat(document.getElementById('cr_input').value)||0, rate=parseFloat(document.getElementById('rate_input').value)||0;
            document.getElementById('tuition_input').value = cr*rate;
            const courses=parseFloat(document.getElementById('courses_input').value)||0, exRate=parseFloat(document.getElementById('exam_rate_input').value)||0;
            document.getElementById('total_exam_input').value = courses*exRate;
        }
        
        // --- UPLOAD HANDLERS ---
        function handleEnrollmentExcelUpload(e) { 
            const y=document.getElementById('enroll_import_year').value, s=document.getElementById('enroll_import_sem').value;
            if(!y||!s) { alert("Select session."); e.target.value=''; return; }
            processExcel(e, 'enrollments', r => ({ reg_no: r.reg, name: r.name, semester: `${s} ${y}`, courses: parseInt(r.courses||0), cr: parseInt(r.cr||0) }));
        }
        function handleDiscountExcelUpload(e) { processExcel(e, 'discounts', r => ({ reg_no: r.reg, name: r.name, term: normalizeTerm(r.term||r.academic), discount: parseFloat((r.discount||r.fa||0).toString().replace('%','')) })); }
        function processExcel(e, type, mapFn) {
            const f=e.target.files[0]; if(!f) return; const r=new FileReader();
            r.onload=async function(ev) {
                const wb=XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const data=json.map(row => { const lRow={}; Object.keys(row).forEach(k=>lRow[k.toLowerCase().trim()]=row[k]); const proxy=new Proxy(lRow, {get:(t,k)=>t[Object.keys(t).find(x=>x.includes(k))]}); return mapFn(proxy); });
                const res=await bulkImport(type, data); if(res.status==='success') alert(`Imported ${data.length}.`);
            }; r.readAsArrayBuffer(f); e.target.value='';
        }
        function downloadDiscountTemplate() { XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet([{ "Reg": "123", "Name": "A", "Academic Term": "Fall 2025", "Discount": 50 }]), "D"), "Template.xlsx"); }
        function downloadEnrollmentTemplate() { XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet([{ "Reg": "123", "Name": "A", "Courses": 5, "Cr": 15 }]), "E"), "Template.xlsx"); }

    </script>
</body>
</html>
