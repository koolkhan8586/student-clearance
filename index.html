<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSAF Fee Management</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- REACT & REACT DOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- BABEL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- FONT AWESOME -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea {
                position: absolute; left: 0; top: 0; width: 100%; height: 100%;
                margin: 0; padding: 10px; background: white;
                transform: scale(0.85); transform-origin: top left;
            }
            #printableArea table { width: 100%; font-size: 10px; border-collapse: collapse; }
            #printableArea th, #printableArea td { padding: 4px; border: 1px solid #000; }
            @page { size: A4; margin: 0; }
            .no-print { display: none !important; }
        }

        /* Error Overlay */
        #js-error-display {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff0f0; color: #d8000c; z-index: 9999; padding: 2rem; font-family: monospace;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div id="js-error-display">
        <h1 class="text-2xl font-bold mb-4">System Error</h1>
        <p>Please reload the page. If the issue persists, contact support.</p>
        <pre id="error-message" class="bg-white p-4 border border-red-300 mt-4 rounded"></pre>
        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded">Reload</button>
    </div>

    <div id="root"></div>

    <script>
        window.onerror = function(msg, source, lineno, colno, error) {
            // Filter out benign script errors from CDNs
            if (msg.toLowerCase().includes('script error')) return false;
            document.getElementById('js-error-display').style.display = 'block';
            document.getElementById('error-message').innerText = msg + '\nLine: ' + lineno;
            return false; 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const API_URL = 'api.php';

        // --- ICONS (SVG Components) ---
        const Icon = ({ d }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>;
        
        // Simple Icon Mapping
        const Icons = {
            Search: () => <Icon d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
            Plus: () => <Icon d="M12 5v14m-7-7h14" />,
            Trash: () => <Icon d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />,
            FileText: () => <Icon d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />,
            Users: () => <Icon d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />,
            Dollar: () => <Icon d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />,
            Book: () => <Icon d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 0 1 3-3h7z" />,
            Card: () => <Icon d="M1 4h22v16H1zM1 10h22" />,
            Percent: () => <Icon d="M19 5L5 19M6.5 6.5h0M17.5 17.5h0" />,
            Print: () => <Icon d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 01 2 2v5a2 2 0 0 1-2 2h-2" />,
            Download: () => <Icon d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            Upload: () => <Icon d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />,
            Alert: () => <Icon d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 8v4M12 16h.01" />,
            Calendar: () => <Icon d="M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zM16 2v4M8 2v4M3 10h18M10 14l4 4M14 14l-4 4" />,
            Shield: () => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            Key: () => <Icon d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />,
            Bank: () => <Icon d="M3 22h18M6 18v-7M10 18v-7M14 18v-7M18 18v-7M12 2l8 5H4z" />,
            Chart: () => <Icon d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />
        };

        function App() {
            // --- STATE ---
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('clearance');
            const [data, setData] = useState({
                students: [], fees: [], enrollments: [], payments: [], discounts: [], others: [], users: [], banks: []
            });
            const [searchReg, setSearchReg] = useState('');
            const [tabSearch, setTabSearch] = useState('');
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [clearanceResult, setClearanceResult] = useState(null);
            
            // Modals & Forms
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({});
            
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [passwordData, setPasswordData] = useState({ current: '', new: '', confirm: '' });
            
            const [loginData, setLoginData] = useState({ username: '', password: '' });
            
            // Import/Summary Features
            const [importPreview, setImportPreview] = useState({ show: false, total: 0, newItems: [], duplicates: [], type: '' });
            const [uploadStatus, setUploadStatus] = useState({ active: false, current: 0, total: 0 });
            const [importTerm, setImportTerm] = useState('');
            const [summaryTerm, setSummaryTerm] = useState('');
            const [summaryData, setSummaryData] = useState(null);
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });

            // --- DATA LOADING ---
            const refreshData = async () => {
                try {
                    const res = await fetch(API_URL);
                    const json = await res.json();
                    
                    // Fallback to empty arrays if API returns partial data
                    const safeData = {
                        students: Array.isArray(json.students) ? json.students : [],
                        fees: Array.isArray(json.fees) ? json.fees : [],
                        enrollments: Array.isArray(json.enrollments) ? json.enrollments : [],
                        payments: Array.isArray(json.payments) ? json.payments : [],
                        discounts: Array.isArray(json.discounts) ? json.discounts : [],
                        others: Array.isArray(json.others) ? json.others : [],
                        users: Array.isArray(json.users) ? json.users : [],
                        banks: Array.isArray(json.banks) ? json.banks : []
                    };
                    setData(safeData);
                } catch(e) {
                    console.error("API Error", e);
                }
            };

            useEffect(() => {
                refreshData();
                try {
                    const sess = sessionStorage.getItem('feeUser');
                    if(sess) setUser(JSON.parse(sess));
                } catch(e){}
            }, []);

            // --- HELPERS ---
            const norm = (str) => str ? String(str).toLowerCase().replace(/[^a-z0-9]/g, '') : '';
            const num = (n) => parseFloat(n || 0).toLocaleString('en-US');
            
            const postToApi = async (action, payload = {}) => {
                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action, ...payload })
                    });
                    const json = await res.json();
                    if(json.status === 'success') { refreshData(); return true; }
                    else { alert("Error: " + json.message); return false; }
                } catch(e) { alert("Connection Error"); return false; }
            };

            // --- AUTH ---
            const handleLogin = (e) => {
                e.preventDefault();
                const found = data.users.find(u => u.username === loginData.username && u.password === loginData.password);
                if(found) {
                    setUser(found);
                    sessionStorage.setItem('feeUser', JSON.stringify(found));
                    // Redirect based on role
                    if(found.role === 'admin' || found.username === 'admin') setActiveTab('clearance');
                    else if(found.permissions && found.permissions.length > 0) setActiveTab(found.permissions[0]);
                    else setActiveTab('clearance');
                } else alert("Invalid Credentials");
            };

            // --- REPORT LOGIC ---
            const generateReport = () => {
                if (!searchReg) return;
                const cleanReg = norm(searchReg);
                const student = data.students.find(s => norm(s.reg_no) === cleanReg);
                if (!student) { alert("Student not found!"); setClearanceResult(null); return; }
                
                const masterFee = data.fees.find(f => norm(f.degree) === norm(student.degree) && norm(f.batch) === norm(student.batch));
                
                const rows = data.enrollments.filter(e => norm(e.reg_no) === cleanReg).map(en => {
                    const cleanSem = norm(en.semester);
                    const cr = parseFloat(en.cr||0);
                    const courses = parseFloat(en.courses||0);
                    
                    let t = 0, x = 0, r = 0, o = 0;
                    if(masterFee) {
                        t = cr * parseFloat(masterFee.per_cr_fee||0);
                        x = courses * parseFloat(masterFee.per_course_fee||0);
                        r = parseFloat(masterFee.reg_fee||0);
                        o = parseFloat(masterFee.other_fee||0); // Base semester fee
                    }
                    
                    // Add manual other charges
                    const extra = data.others.filter(oth => norm(oth.reg_no) === cleanReg && norm(oth.semester).includes(cleanSem))
                        .reduce((acc, curr) => acc + parseFloat(curr.amount||0), 0);
                    o += extra;

                    const total = t + x + r + o;

                    // Discount
                    const disc = data.discounts.find(d => norm(d.reg_no) === cleanReg && norm(d.term).includes(cleanSem));
                    const discPct = disc ? parseFloat(disc.discount||0) : 0;
                    const discAmt = (t * discPct) / 100; // Discount on Tuition usually
                    
                    const net = total - discAmt;

                    // Payment
                    const paid = data.payments.filter(p => norm(p.reg_no) === cleanReg && norm(p.semester).includes(cleanSem))
                        .reduce((acc, p) => acc + parseFloat(p.amount||0), 0);
                    
                    return {
                        ...en, tuition: t, exam: x, reg: r, other: o, total, discPct, discAmt, netFee: net, totalPaid: paid, balance: net - paid
                    };
                });

                const summary = rows.reduce((acc, r) => ({
                    total: acc.total + r.total,
                    fa: acc.fa + r.discAmt,
                    paid: acc.paid + r.totalPaid,
                    balance: acc.balance + r.balance,
                    cr: acc.cr + parseFloat(r.cr||0),
                    courses: acc.courses + parseFloat(r.courses||0)
                }), { total:0, fa:0, paid:0, balance:0, cr:0, courses:0 });

                setClearanceResult({ student, rows, summary, masterFeeFound: !!masterFee, masterFee });
            };

            const generateSummary = () => {
                if(!summaryTerm) return;
                const term = norm(summaryTerm);
                const enrs = data.enrollments.filter(e => norm(e.semester).includes(term));
                
                let proj = 0, disc = 0, rec = 0, manualOth = 0;
                let t_tui = 0, t_exm = 0, t_oth = 0;

                enrs.forEach(en => {
                    const st = data.students.find(s => norm(s.reg_no) === norm(en.reg_no));
                    if(st) {
                        const fee = data.fees.find(f => norm(f.degree) === norm(st.degree) && norm(f.batch) === norm(st.batch));
                        if(fee) {
                            const cr = parseFloat(en.cr||0);
                            const c = parseFloat(en.courses||0);
                            const t = cr * parseFloat(fee.per_cr_fee||0);
                            const x = c * parseFloat(fee.per_course_fee||0);
                            const o = parseFloat(fee.reg_fee||0) + parseFloat(fee.other_fee||0);
                            
                            t_tui += t; t_exm += x; t_oth += o;
                            const sub = t + x + o;
                            proj += sub;

                            const d = data.discounts.find(dx => norm(dx.reg_no) === norm(en.reg_no) && norm(dx.term).includes(term));
                            if(d) disc += (t * parseFloat(d.discount||0))/100;
                        }
                    }
                });

                manualOth = data.others.filter(o => norm(o.semester).includes(term)).reduce((a,c) => a + parseFloat(c.amount||0), 0);
                rec = data.payments.filter(p => norm(p.semester).includes(term)).reduce((a,c) => a + parseFloat(c.amount||0), 0);
                
                t_oth += manualOth;
                proj += manualOth;

                setSummaryData({
                    enrollmentCount: enrs.length,
                    totalProjected: proj,
                    totalTuition: t_tui,
                    totalExamFee: t_exm,
                    totalOthers: t_oth,
                    totalDiscounts: disc,
                    netReceivable: proj - disc,
                    totalReceived: rec,
                    balance: (proj - disc) - rec
                });
            };

            // --- CRUD ---
            const handleSave = async (e) => {
                e.preventDefault();
                const newData = { ...formData };
                // Auto name
                if(['payments','others'].includes(modalType) && !newData.name) {
                    const s = data.students.find(st => norm(st.reg_no) === norm(newData.reg_no));
                    if(s) newData.name = s.name;
                }
                
                let type = modalType.endsWith('s') ? modalType.slice(0, -1) : modalType;
                if(modalType === 'others') type = 'other';
                
                const ok = await postToApi(`save_${type}`, { data: newData, id: editingId });
                if(ok) { setShowModal(false); setFormData({}); setEditingId(null); }
            };

            const handleDelete = async (type, id) => {
                if(!confirm("Delete?")) return;
                let at = type.endsWith('s') ? type.slice(0, -1) : type;
                if(type === 'others') at = 'other';
                await postToApi(`delete_${at}`, { id });
            };

            const handleImport = (e, type) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    const rows = text.split('\n').map(r=>r.trim()).filter(r=>r);
                    if(rows.length < 2) return;
                    const headers = rows[0].split(',').map(h=>h.trim().toLowerCase().replace(/ /g,'_'));
                    const newItems = [];
                    const dups = [];
                    const existing = data[type] || [];

                    for(let i=1; i<rows.length; i++) {
                        const vals = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        const obj = {};
                        headers.forEach((h, idx) => {
                            let val = vals[idx] ? vals[idx].trim() : '';
                            if(val.startsWith('"')) val = val.slice(1,-1);
                            
                            if(h.includes('reg')) obj.reg_no = val;
                            else if(h.includes('name') && !h.includes('fee') && !h.includes('user')) obj.name = val;
                            else if(h.includes('semester')) obj.semester = val;
                            else if(h.includes('amount')) obj.amount = val;
                            else if(h === 'cr') obj.cr = val;
                            else if(h.includes('course')) obj.courses = val;
                            else if(h.includes('degree')) obj.degree = val;
                            else if(h.includes('batch')) obj.batch = val;
                            else if(h.includes('term')) obj.term = val;
                            else if(h.includes('fee') && h.includes('name')) obj.fee_name = val;
                            else if(h.includes('account')) obj.account_no = val;
                            else if(h.includes('user')) obj.username = val;
                            else if(h.includes('pass')) obj.password = val;
                            else if(h.includes('role')) obj.role = val;
                            else obj[h] = val;
                        });
                        
                        if(importTerm) {
                            if(['enrollments','payments','others'].includes(type)) obj.semester = importTerm;
                            if(type==='discounts') obj.term = importTerm;
                        }
                        if(obj.amount) obj.amount = obj.amount.replace(/[^0-9.-]/g, '');

                        // Check Dup
                        let isDup = false;
                        if(type === 'payments') {
                             isDup = existing.some(ex => norm(ex.reg_no) === norm(obj.reg_no) && parseFloat(ex.amount) === parseFloat(obj.amount) && ex.date === obj.date);
                        } else {
                             isDup = existing.some(ex => norm(ex.reg_no) === norm(obj.reg_no) && (norm(ex.semester||ex.term) === norm(obj.semester||obj.term)));
                        }
                        
                        if(isDup) dups.push(obj);
                        else newItems.push(obj);
                    }
                    setImportPreview({ show: true, type, newItems, duplicates: dups, total: rows.length-1 });
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            const confirmImport = async () => {
                setUploadStatus({ active: true, current: 0, total: importPreview.newItems.length });
                let type = importPreview.type.endsWith('s') ? importPreview.type.slice(0,-1) : importPreview.type;
                if(importPreview.type === 'others') type = 'other';
                
                let count = 0;
                for(const item of importPreview.newItems) {
                    await postToApi(`save_${type}`, { data: item });
                    count++;
                    setUploadStatus(prev => ({...prev, current: count}));
                }
                setImportPreview({ show: false, newItems:[], duplicates:[], total:0, type:'' });
                setUploadStatus({ active: false, current:0, total:0 });
                alert(`Imported ${count} records.`);
                refreshData();
            };

            const deleteAll = async () => {
                if(!confirm(`Delete ALL records in ${activeTab}?`)) return;
                await postToApi('delete_all', { table: activeTab });
                refreshData();
            };

            const deleteSem = async () => {
                const term = prompt("Enter Semester:");
                if(!term) return;
                await postToApi('delete_semester', { table: activeTab, term });
                refreshData();
            };

            // RENDER HELPERS
            const TableHeader = () => {
                const map = {
                    students: ['Reg No', 'Name', 'Degree', 'Batch', 'Mobile', 'Email'],
                    fees: ['Degree', 'Batch', 'Fee/Cr', 'Fee/Sub', 'Reg Fee', 'Other'],
                    enrollments: ['Reg No', 'Name', 'Semester', 'Cr Hrs', 'Courses'],
                    payments: ['Reg No', 'Name', 'Semester', 'Amount', 'Date', 'Bank'],
                    discounts: ['Reg No', 'Name', 'Term', 'Discount %'],
                    others: ['Reg No', 'Name', 'Semester', 'Fee Name', 'Amount'],
                    users: ['Username', 'Role', 'Permissions'],
                    banks: ['Bank Name', 'Account No']
                };
                const headers = map[activeTab] || [];
                return (
                    <thead>
                        <tr className="bg-gray-100 border-b">
                            <th className="p-3 w-10">#</th>
                            {headers.map(h => <th key={h} className="p-3 text-left font-bold text-xs uppercase text-gray-600">{h}</th>)}
                            <th className="p-3 text-center">Actions</th>
                        </tr>
                    </thead>
                );
            };

            const TableRow = ({ item, idx }) => {
                return (
                    <tr className="border-b hover:bg-gray-50 transition text-sm">
                        <td className="p-3 text-gray-400">{idx+1}</td>
                        {activeTab === 'students' && <><td className="p-3 font-mono">{item.reg_no}</td><td className="p-3 font-bold">{item.name}</td><td className="p-3"><span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{item.degree}</span></td><td className="p-3">{item.batch}</td><td className="p-3">{item.mobile}</td><td className="p-3">{item.email}</td></>}
                        {activeTab === 'fees' && <><td className="p-3 font-bold">{item.degree}</td><td className="p-3">{item.batch}</td><td className="p-3 text-right">{num(item.per_cr_fee)}</td><td className="p-3 text-right">{num(item.per_course_fee)}</td><td className="p-3 text-right">{num(item.reg_fee)}</td><td className="p-3 text-right">{num(item.other_fee)}</td></>}
                        {activeTab === 'enrollments' && <><td className="p-3 font-mono">{item.reg_no}</td><td className="p-3">{item.name}</td><td className="p-3"><span className="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">{item.semester}</span></td><td className="p-3">{item.cr}</td><td className="p-3">{item.courses}</td></>}
                        {activeTab === 'payments' && <><td className="p-3 font-mono">{item.reg_no}</td><td className="p-3">{item.name}</td><td className="p-3"><span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">{item.semester}</span></td><td className="p-3 text-right font-bold">{num(item.amount)}</td><td className="p-3">{item.date}</td><td className="p-3">{item.bank}</td></>}
                        {activeTab === 'others' && <><td className="p-3 font-mono">{item.reg_no}</td><td className="p-3">{item.name}</td><td className="p-3">{item.semester}</td><td className="p-3"><span className="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">{item.fee_name}</span></td><td className="p-3 text-right font-bold">{num(item.amount)}</td></>}
                        {activeTab === 'discounts' && <><td className="p-3 font-mono">{item.reg_no}</td><td className="p-3">{item.name}</td><td className="p-3">{item.term}</td><td className="p-3 font-bold text-purple-600">{item.discount}%</td></>}
                        {activeTab === 'users' && <><td className="p-3 font-bold">{item.username}</td><td className="p-3 capitalize">{item.role}</td><td className="p-3 text-xs">{Array.isArray(item.permissions) ? item.permissions.join(', ') : 'All'}</td></>}
                        {activeTab === 'banks' && <><td className="p-3 font-bold">{item.name}</td><td className="p-3 font-mono">{item.account_no}</td></>}
                        <td className="p-3 text-center flex justify-center gap-2">
                            <button onClick={() => { setModalType(activeTab); setFormData(item); setEditingId(item.id || item.reg_no); setShowModal(true); }} className="text-blue-600 hover:text-blue-800"><i className="fas fa-edit"></i></button>
                            <button onClick={() => handleDelete(activeTab, item.id || item.reg_no)} className="text-red-500 hover:text-red-700"><Trash2 /></button>
                        </td>
                    </tr>
                );
            };

            // VIEW RENDER
            if(!user) return (
                <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                        <div className="flex justify-center mb-6"><img src="src/UOL-Green-V1.png" className="h-24 object-contain" /></div>
                        <h2 className="text-center text-xl font-bold mb-6">LSAF Fee Management</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input className="w-full border p-3 rounded" placeholder="Username" value={loginData.username} onChange={e=>setLoginData({...loginData, username:e.target.value})} />
                            <input className="w-full border p-3 rounded" type="password" placeholder="Password" value={loginData.password} onChange={e=>setLoginData({...loginData, password:e.target.value})} />
                            <button className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Login</button>
                        </form>
                    </div>
                </div>
            );

            // Filter
            const list = (data[activeTab] || []).filter(i => !tabSearch || Object.values(i).some(v => String(v).toLowerCase().includes(tabSearch.toLowerCase())));

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800 pb-20">
                    {/* Header */}
                    <div className="bg-white shadow-md border-b sticky top-0 z-30 px-6 py-3 flex justify-between items-center no-print">
                        <div className="flex items-center gap-4">
                            <img src="src/UOL-Green-V1.png" className="h-10" />
                            <h1 className="font-bold text-lg hidden md:block">LSAF Fee Manager</h1>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            {user.role === 'admin' || user.username === 'admin' ? TABS.concat({id:'users', label:'Users', icon:Users}).map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition ${activeTab === t.id ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    <t.icon /> {t.label}
                                </button>
                            )) : TABS.filter(t => user.permissions?.includes(t.id)).map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition ${activeTab === t.id ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}><t.icon /> {t.label}</button>
                            ))}
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="text-right hidden sm:block leading-tight">
                                <div className="font-bold text-sm">{user.username}</div>
                                <div className="text-xs text-gray-500 uppercase">{user.role}</div>
                            </div>
                            <button onClick={() => window.print()} className="p-2 bg-gray-100 rounded hover:bg-gray-200"><Printer /></button>
                            <button onClick={() => {setUser(null); sessionStorage.clear();}} className="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200"><i className="fas fa-sign-out-alt"></i></button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-6">
                        {activeTab === 'clearance' ? (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow-sm flex gap-4 no-print">
                                    <input className="flex-1 border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter Registration No (e.g. BSCAF052530040)" value={searchReg} onChange={e=>setSearchReg(e.target.value)} onKeyDown={e=>e.key==='Enter' && generateReport()} />
                                    <button onClick={generateReport} className="bg-blue-600 text-white px-8 rounded-lg font-bold hover:bg-blue-700">Generate</button>
                                </div>
                                {clearanceResult && (
                                    <div id="printableArea" className="bg-white p-10 shadow-lg rounded-xl">
                                        <div className="flex justify-between items-start border-b-2 border-gray-800 pb-6 mb-6">
                                            <img src="src/UOL-Green-V1.png" className="w-24" />
                                            <div className="text-center">
                                                <h1 className="text-2xl font-bold uppercase text-gray-900">The University of Lahore</h1>
                                                <p className="text-gray-600 font-medium">School of Accountancy & Finance</p>
                                                <span className="inline-block bg-gray-100 px-3 py-1 rounded mt-2 text-xs font-bold uppercase">Fee Clearance Report</span>
                                            </div>
                                            <div className="text-right text-xs text-gray-500"><p>Printed: {new Date().toLocaleString()}</p></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-6 mb-6 text-sm">
                                            <div className="flex border-b py-1"><span className="font-bold w-32">Registration No:</span> {clearanceResult.student.reg_no}</div>
                                            <div className="flex border-b py-1"><span className="font-bold w-32">Student Name:</span> {clearanceResult.student.name}</div>
                                            <div className="flex border-b py-1"><span className="font-bold w-32">Degree:</span> {clearanceResult.student.degree}</div>
                                            <div className="flex border-b py-1"><span className="font-bold w-32">Batch:</span> {clearanceResult.student.batch}</div>
                                        </div>
                                        <table className="w-full text-xs mb-6">
                                            <thead className="bg-gray-100 uppercase font-bold">
                                                <tr><th className="p-2 border">Sem</th><th className="p-2 border text-center">Sub</th><th className="p-2 border text-center">Cr</th><th className="p-2 border text-right">Tuition</th><th className="p-2 border text-right">Exam</th><th className="p-2 border text-right">Reg</th><th className="p-2 border text-right">Other</th><th className="p-2 border text-right bg-gray-50">Total</th><th className="p-2 border text-center">Disc</th><th className="p-2 border text-right">Amt</th><th className="p-2 border text-right">Net</th><th className="p-2 border text-right">Paid</th><th className="p-2 border text-right">Bal</th></tr>
                                            </thead>
                                            <tbody>
                                                {clearanceResult.rows.map((r, i) => (
                                                    <tr key={i}>
                                                        <td className="p-2 border font-bold">{r.semester}</td><td className="p-2 border text-center">{r.courses}</td><td className="p-2 border text-center">{r.cr}</td><td className="p-2 border text-right">{num(r.tuition)}</td><td className="p-2 border text-right">{num(r.exam)}</td><td className="p-2 border text-right">{num(r.reg)}</td><td className="p-2 border text-right">{num(r.other)}</td><td className="p-2 border text-right font-bold bg-gray-50">{num(r.total)}</td><td className="p-2 border text-center">{r.discPct}%</td><td className="p-2 border text-right">{num(r.discAmt)}</td><td className="p-2 border text-right font-bold">{num(r.netFee)}</td><td className="p-2 border text-right text-green-700 font-bold">{num(r.totalPaid)}</td><td className="p-2 border text-right font-bold">{num(r.balance)}</td>
                                                    </tr>
                                                ))}
                                                <tr className="bg-gray-800 text-white font-bold"><td colSpan="7" className="p-2 text-right">Totals</td><td className="p-2 text-right">{num(clearanceResult.summary.total)}</td><td></td><td className="p-2 text-right">{num(clearanceResult.summary.fa)}</td><td className="p-2 text-right">{num(clearanceResult.summary.total - clearanceResult.summary.fa)}</td><td className="p-2 text-right">{num(clearanceResult.summary.paid)}</td><td className="p-2 text-right">{num(clearanceResult.summary.balance)}</td></tr>
                                            </tbody>
                                        </table>
                                        <div className="flex justify-between items-end mt-12">
                                            <div className="text-xs text-gray-500">Printed by: {user.username}</div>
                                            <div className="w-64 border-t border-black text-center pt-2 font-bold text-sm">Accounts Officer</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : activeTab === 'summary' ? (
                             <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Term Financial Summary</label>
                                    <div className="flex gap-3">
                                        <input type="text" value={summaryTerm} onChange={(e) => setSummaryTerm(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && generateSummary()} placeholder="Enter Term (e.g. Fall 2024)" className="flex-1 block w-full rounded-lg border-gray-300 border p-3 focus:ring-2 focus:ring-blue-500 outline-none" />
                                        <button onClick={generateSummary} className="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition flex items-center gap-2"><Search className="h-5 w-5" /> Calculate</button>
                                    </div>
                                </div>
                                {summaryData && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Projected Revenue</p>
                                            <h3 className="text-2xl font-bold text-gray-900 mt-1">{num(summaryData.totalProjected)}</h3>
                                            <p className="text-xs text-gray-400 mt-1">Based on {summaryData.enrollmentCount} Enrollments</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Tuition Fee</p>
                                            <h3 className="text-2xl font-bold text-purple-600 mt-1">{num(summaryData.totalTuition)}</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Exam Fee</p>
                                            <h3 className="text-2xl font-bold text-indigo-600 mt-1">{num(summaryData.totalExamFee)}</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Other Charges</p>
                                            <h3 className="text-2xl font-bold text-yellow-600 mt-1">{num(summaryData.totalOthers)}</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Discounts Given</p>
                                            <h3 className="text-2xl font-bold text-orange-600 mt-1">{num(summaryData.totalDiscounts)}</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-teal-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Net Receivable</p>
                                            <h3 className="text-2xl font-bold text-teal-600 mt-1">{num(summaryData.netReceivable)}</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Total Received</p>
                                            <h3 className="text-2xl font-bold text-green-600 mt-1">{num(summaryData.totalReceived)}</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Outstanding Balance</p>
                                            <h3 className="text-2xl font-bold text-red-600 mt-1">{num(summaryData.balance)}</h3>
                                            <p className="text-xs text-gray-400 mt-1">Receivable Amount</p>
                                        </div>
                                    </div>
                                )}
                             </div>
                        ) : (
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center no-print">
                                    <div className="flex gap-2 w-full max-w-xl">
                                        <input className="border p-2 rounded flex-1 outline-none focus:ring-1" placeholder="Search..." value={tabSearch} onChange={e=>setTabSearch(e.target.value)} />
                                    </div>
                                    <div className="flex gap-2">
                                        {/* Import Term Input */}
                                        {['enrollments','payments','others','discounts'].includes(activeTab) && 
                                            <input className="border p-2 rounded w-32 text-sm" placeholder="Import Term" value={importTerm} onChange={e=>setImportTerm(e.target.value)} />
                                        }
                                        <button onClick={()=>openModal(activeTab)} className="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm"><Plus /> Add</button>
                                        <label className="bg-white border px-3 py-2 rounded cursor-pointer text-sm font-bold text-gray-600"><Download /> Import <input type="file" className="hidden" onChange={e=>handleImport(e, activeTab)} /></label>
                                        <button onClick={()=>handleExport(activeTab)} className="bg-white border px-3 py-2 rounded text-sm font-bold text-gray-600"><Upload /> Export</button>
                                        <button onClick={()=>downloadSample(activeTab)} className="bg-white border px-3 py-2 rounded text-sm font-bold text-gray-600"><FileSpreadsheet /> Sample</button>
                                        {user.role === 'admin' && <button onClick={()=>deleteAll(activeTab)} className="bg-red-50 text-red-600 border border-red-200 px-3 py-2 rounded text-sm font-bold"><XSquare /> Del All</button>}
                                        {(activeTab === 'enrollments' || activeTab === 'payments' || activeTab === 'others') && <button onClick={deleteSem} className="bg-orange-50 text-orange-600 border border-orange-200 px-3 py-2 rounded text-sm font-bold"><CalendarX /> Del Sem</button>}
                                        {selectedIds.size > 0 && <button onClick={deleteSelected} className="bg-red-600 text-white px-3 py-2 rounded text-sm font-bold animate-pulse">Delete ({selectedIds.size})</button>}
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <TableHeader />
                                        <tbody className="divide-y divide-gray-100">
                                            {list.map((item, idx) => <TableRow key={item.id||idx} item={item} idx={idx} />)}
                                            {list.length === 0 && <tr><td colSpan="10" className="p-8 text-center text-gray-400">No records found.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* MODAL */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4 capitalize">Add/Edit {modalType.replace(/s$/,'')}</h3>
                                <form onSubmit={handleSave} className="space-y-4">
                                    {/* DYNAMIC FORM FIELDS */}
                                    {modalType === 'students' && <><input required placeholder="Reg No" className="w-full border p-2 rounded" value={formData.reg_no||''} onChange={e=>setFormData({...formData, reg_no:e.target.value})} /><input placeholder="Name" className="w-full border p-2 rounded" value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} /><div className="grid grid-cols-2 gap-4"><input placeholder="Degree" className="w-full border p-2 rounded" value={formData.degree||''} onChange={e=>setFormData({...formData, degree:e.target.value})} /><input placeholder="Batch" className="w-full border p-2 rounded" value={formData.batch||''} onChange={e=>setFormData({...formData, batch:e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><input placeholder="Mobile" className="w-full border p-2 rounded" value={formData.mobile||''} onChange={e=>setFormData({...formData, mobile:e.target.value})} /><input placeholder="Email" className="w-full border p-2 rounded" value={formData.email||''} onChange={e=>setFormData({...formData, email:e.target.value})} /></div></>}
                                    {modalType === 'fees' && <><div className="grid grid-cols-2 gap-4"><input placeholder="Degree" className="w-full border p-2 rounded" value={formData.degree||''} onChange={e=>setFormData({...formData, degree:e.target.value})} /><input placeholder="Batch" className="w-full border p-2 rounded" value={formData.batch||''} onChange={e=>setFormData({...formData, batch:e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><input type="number" placeholder="Fee/Cr" className="w-full border p-2 rounded" value={formData.per_cr_fee||''} onChange={e=>setFormData({...formData, per_cr_fee:e.target.value})} /><input type="number" placeholder="Fee/Sub" className="w-full border p-2 rounded" value={formData.per_course_fee||''} onChange={e=>setFormData({...formData, per_course_fee:e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><input type="number" placeholder="Reg Fee" className="w-full border p-2 rounded" value={formData.reg_fee||''} onChange={e=>setFormData({...formData, reg_fee:e.target.value})} /><input type="number" placeholder="Other" className="w-full border p-2 rounded" value={formData.other_fee||''} onChange={e=>setFormData({...formData, other_fee:e.target.value})} /></div></>}
                                    {modalType === 'enrollments' && <><input required placeholder="Reg No" className="w-full border p-2 rounded" value={formData.reg_no||''} onChange={e=>setFormData({...formData, reg_no:e.target.value})} /><input placeholder="Name" className="w-full border p-2 rounded" value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} /><input required placeholder="Semester" className="w-full border p-2 rounded" value={formData.semester||''} onChange={e=>setFormData({...formData, semester:e.target.value})} /><div className="grid grid-cols-2 gap-4"><input type="number" placeholder="Cr Hrs" className="w-full border p-2 rounded" value={formData.cr||''} onChange={e=>setFormData({...formData, cr:e.target.value})} /><input type="number" placeholder="Courses" className="w-full border p-2 rounded" value={formData.courses||''} onChange={e=>setFormData({...formData, courses:e.target.value})} /></div></>}
                                    {modalType === 'payments' && <><input required placeholder="Reg No" className="w-full border p-2 rounded" value={formData.reg_no||''} onChange={e=>setFormData({...formData, reg_no:e.target.value})} /><input required placeholder="Semester" className="w-full border p-2 rounded" value={formData.semester||''} onChange={e=>setFormData({...formData, semester:e.target.value})} /><input required type="number" placeholder="Amount" className="w-full border p-2 rounded font-bold" value={formData.amount||''} onChange={e=>setFormData({...formData, amount:e.target.value})} /><input type="date" className="w-full border p-2 rounded" value={formData.date||''} onChange={e=>setFormData({...formData, date:e.target.value})} /><select className="w-full border p-2 rounded bg-white" value={formData.bank||''} onChange={e=>setFormData({...formData, bank:e.target.value})}><option value="">Select Bank</option><option value="Cash">Cash</option>{data.banks.map(b=><option key={b.id} value={b.name}>{b.name}</option>)}</select></>}
                                    {modalType === 'discounts' && <><input required placeholder="Reg No" className="w-full border p-2 rounded" value={formData.reg_no||''} onChange={e=>setFormData({...formData, reg_no:e.target.value})} /><input placeholder="Term" className="w-full border p-2 rounded" value={formData.term||''} onChange={e=>setFormData({...formData, term:e.target.value})} /><input type="number" placeholder="Discount %" className="w-full border p-2 rounded" value={formData.discount||''} onChange={e=>setFormData({...formData, discount:e.target.value})} /></>}
                                    {modalType === 'others' && <><input required placeholder="Reg No" className="w-full border p-2 rounded" value={formData.reg_no||''} onChange={e=>setFormData({...formData, reg_no:e.target.value})} /><div className="grid grid-cols-2 gap-4"><input placeholder="Semester" className="w-full border p-2 rounded" value={formData.semester||''} onChange={e=>setFormData({...formData, semester:e.target.value})} /><input placeholder="Fee Name" className="w-full border p-2 rounded" value={formData.fee_name||''} onChange={e=>setFormData({...formData, fee_name:e.target.value})} /></div><input type="number" placeholder="Amount" className="w-full border p-2 rounded" value={formData.amount||''} onChange={e=>setFormData({...formData, amount:e.target.value})} /></>}
                                    {modalType === 'banks' && <><input placeholder="Bank Name" className="w-full border p-2 rounded" value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} /><input placeholder="Account No" className="w-full border p-2 rounded" value={formData.account_no||''} onChange={e=>setFormData({...formData, account_no:e.target.value})} /></>}
                                    {modalType === 'users' && <div className="space-y-4"><input placeholder="Username" className="w-full border p-2 rounded" value={formData.username||''} onChange={e=>setFormData({...formData, username:e.target.value})} /><input type="password" placeholder="Password" className="w-full border p-2 rounded" value={formData.password||''} onChange={e=>setFormData({...formData, password:e.target.value})} /><select className="w-full border p-2 rounded bg-white" value={formData.role||'user'} onChange={e=>setFormData({...formData, role:e.target.value})}><option value="user">User</option><option value="admin">Admin</option></select></div>}
                                    
                                    <div className="flex justify-end gap-3 pt-4"><button type="button" onClick={()=>setShowModal(false)} className="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200">Cancel</button><button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button></div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* IMPORT PREVIEW */}
                    {importPreview.show && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
                                <h3 className="text-xl font-bold mb-4">Import Preview</h3>
                                <div className="space-y-2 mb-4">
                                    <p>Total Records: <strong>{importPreview.total}</strong></p>
                                    <p className="text-green-600">New Records: <strong>{importPreview.newItems.length}</strong></p>
                                    <p className="text-red-600">Duplicates: <strong>{importPreview.duplicates.length}</strong></p>
                                </div>
                                {importPreview.duplicates.length > 0 && <div className="bg-red-50 p-3 rounded text-sm text-red-700 mb-4 max-h-40 overflow-y-auto"><strong>Duplicates:</strong> {importPreview.duplicates.map(d=>d.reg_no).join(', ')}</div>}
                                {uploadStatus.active && <div className="w-full bg-gray-200 rounded-full h-4 mb-4"><div className="bg-blue-600 h-4 rounded-full transition-all duration-300" style={{width: `${(uploadStatus.current/uploadStatus.total)*100}%`}}></div></div>}
                                <div className="flex justify-end gap-3"><button onClick={()=>setImportPreview({show:false, newItems:[], duplicates:[], total:0})} className="px-4 py-2 bg-gray-100 rounded">Cancel</button><button onClick={confirmImport} className="px-6 py-2 bg-blue-600 text-white rounded">Import {importPreview.newItems.length} Records</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
