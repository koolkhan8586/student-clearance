<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Fee Management</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- REACT & REACT DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- BABEL (To compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FONT & ICONS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Custom Scrollbar for a cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #printableArea, #printableArea * {
                visibility: visible;
            }
            #printableArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px; /* Add some padding for better fit */
                box-shadow: none !important;
                border: none !important;
            }
            /* Hide URL/Page info headers/footers in modern browsers if possible via @page, though browser settings override this */
            @page {
                size: auto;
                margin: 0mm;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS (Lucide style SVGs) ---
        const Icon = ({ d, ...props }) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d={d} />
            </svg>
        );
        
        // Simplified icon definitions mapping to paths or groups
        const Search = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const Plus = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Trash2 = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const FileText = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const Users = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const DollarSign = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const BookOpen = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
        const CreditCard = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>;
        const Percent = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>;
        const Printer = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>;
        const Download = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Upload = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const FileSpreadsheet = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>;
        const XSquare = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>;

        function App() {
            // --- STATE MANAGEMENT ---
            const [activeTab, setActiveTab] = useState('clearance');
            const [data, setData] = useState({
                students: [],
                fees: [],
                enrollments: [],
                payments: [],
                discounts: []
            });
            
            // Search & Filter States
            const [searchReg, setSearchReg] = useState(''); // For Clearance Report
            const [tabSearch, setTabSearch] = useState(''); // For Data Tabs
            const [selectedIds, setSelectedIds] = useState(new Set()); // For Bulk Actions
            const [clearanceResult, setClearanceResult] = useState(null);
            
            // Modal States
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({});

            // --- PERSISTENCE ---
            useEffect(() => {
                const saved = localStorage.getItem('feeSystemData_v2');
                if (saved) {
                    try { setData(JSON.parse(saved)); } 
                    catch (e) { console.error("Failed to load data", e); }
                } else {
                    // MIGRATION: Try to load from old HTML system key
                    const oldData = localStorage.getItem('fee_system_local');
                    if (oldData) {
                        try {
                            const parsed = JSON.parse(oldData);
                            const migratedData = {
                                students: parsed.students || [],
                                fees: parsed.fees || [],
                                enrollments: parsed.enrollments || [],
                                payments: parsed.payments || [],
                                discounts: parsed.discounts || []
                            };
                            setData(migratedData);
                            localStorage.setItem('feeSystemData_v2', JSON.stringify(migratedData));
                            alert("Data restored from previous version!");
                        } catch (e) { console.error("Migration failed", e); }
                    }
                }
            }, []);

            useEffect(() => {
                // Save whenever data changes
                if (data.students.length > 0 || data.fees.length > 0 || data.payments.length > 0) {
                    localStorage.setItem('feeSystemData_v2', JSON.stringify(data));
                }
            }, [data]);

            useEffect(() => {
                setSelectedIds(new Set());
                setTabSearch('');
            }, [activeTab]);

            // --- HELPERS ---
            const norm = (str) => str ? str.toString().toLowerCase().replace(/[^a-z0-9]/g, '') : '';
            const num = (n) => parseFloat(n || 0).toLocaleString('en-US');
            
            // --- IMPORT / EXPORT LOGIC ---
            const getHeaders = (type) => {
                switch(type) {
                    case 'students': return ['reg_no', 'name', 'degree', 'batch'];
                    case 'fees': return ['degree', 'batch', 'per_cr_fee', 'per_course_fee', 'reg_fee', 'other_fee'];
                    case 'enrollments': return ['reg_no', 'name', 'semester', 'cr', 'courses'];
                    case 'payments': return ['reg_no', 'name', 'semester', 'amount', 'date'];
                    case 'discounts': return ['reg_no', 'name', 'term', 'discount'];
                    default: return [];
                }
            };

            const downloadSample = (type) => {
                const headers = getHeaders(type);
                const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${type}_sample.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleExport = (type) => {
                const records = data[type];
                if (!records || records.length === 0) return alert("No data to export");
                const headers = getHeaders(type);
                const csvRows = [
                    headers.join(','),
                    ...records.map(row => headers.map(fieldName => {
                        let val = row[fieldName] || '';
                        if (typeof val === 'string' && val.includes(',')) val = `"${val}"`; 
                        return val;
                    }).join(','))
                ];
                const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${type}_export.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImport = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    const rows = text.split('\n').map(r => r.trim()).filter(r => r);
                    if (rows.length < 2) return; 
                    const headers = rows[0].split(',').map(h => h.trim());
                    const newItems = [];
                    for (let i = 1; i < rows.length; i++) {
                        const values = rows[i].split(',');
                        const obj = { id: Date.now().toString() + Math.random().toString(36).substr(2, 9) };
                        headers.forEach((h, index) => {
                            let val = values[index];
                            if (val && val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                            obj[h] = val;
                        });
                        newItems.push(obj);
                    }
                    setData(prev => ({ ...prev, [type]: [...prev[type], ...newItems] }));
                    alert(`Imported ${newItems.length} records!`);
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            // --- CORE LOGIC: CLEARANCE REPORT ---
            const generateReport = () => {
                if (!searchReg) return;
                const cleanReg = norm(searchReg);
                const student = data.students.find(s => norm(s.reg_no) === cleanReg);
                if (!student) {
                    alert("Student not found!");
                    setClearanceResult(null);
                    return;
                }
                
                // UNIVERSAL FEE LOGIC: Match by Degree & Batch only
                const masterFee = data.fees.find(f => 
                    norm(f.degree) === norm(student.degree) && 
                    norm(f.batch) === norm(student.batch)
                );

                const studentEnrollments = data.enrollments
                    .filter(e => norm(e.reg_no) === cleanReg)
                    .map(en => {
                        const enSem = norm(en.semester);
                        const cr = parseFloat(en.cr || 0);
                        const courses = parseFloat(en.courses || 0);
                        let feeDetails = { tuition: 0, exam: 0, reg: 0, other: 0, total: 0 };
                        
                        if (masterFee) {
                            // RATES x QUANTITY
                            feeDetails.tuition = cr * parseFloat(masterFee.per_cr_fee || 0);
                            feeDetails.exam = courses * parseFloat(masterFee.per_course_fee || 0); // "Subject/Enrollment" Fee
                            
                            feeDetails.reg = parseFloat(masterFee.reg_fee || 0);
                            feeDetails.other = parseFloat(masterFee.other_fee || 0);
                            feeDetails.total = feeDetails.tuition + feeDetails.exam + feeDetails.reg + feeDetails.other;
                        }

                        const discRecord = data.discounts.find(d => norm(d.reg_no) === cleanReg && norm(d.term) === enSem);
                        const discPct = discRecord ? parseFloat(discRecord.discount || 0) : 0;
                        const discAmt = (feeDetails.total * discPct) / 100;
                        const netFee = feeDetails.total - discAmt;

                        // Flexible Payment Matching
                        const payments = data.payments.filter(p => {
                            if (norm(p.reg_no) !== cleanReg) return false;
                            const pSem = norm(p.semester);
                            // Match 'Spring 2024', 'spring2024', 'spring24' to 'spring2024'
                            return pSem === enSem || 
                                   (enSem.includes(pSem) && pSem.length > 3) || 
                                   (pSem.includes(enSem) && enSem.length > 3);
                        });

                        const totalPaid = payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
                        const balance = netFee - totalPaid;
                        return { ...en, ...feeDetails, discPct, discAmt, netFee, totalPaid, balance };
                    });

                const summary = studentEnrollments.reduce((acc, curr) => ({
                    total: acc.total + curr.total,
                    fa: acc.fa + curr.discAmt,
                    paid: acc.paid + curr.totalPaid,
                    balance: acc.balance + curr.balance
                }), { total: 0, fa: 0, paid: 0, balance: 0 });

                setClearanceResult({ student, rows: studentEnrollments, summary, masterFeeFound: !!masterFee });
            };

            // --- CRUD ACTIONS ---
            const handleDelete = (type, id) => {
                if(!window.confirm("Are you sure?")) return;
                setData(prev => ({ ...prev, [type]: prev[type].filter(item => item.id !== id) }));
            };

            const handleSave = (e) => {
                e.preventDefault();
                const newData = { ...formData, id: editingId || Date.now().toString() };
                
                if (modalType === 'fees') {
                    const cr = parseFloat(newData.cr || 0);
                    const rate = parseFloat(newData.per_cr_fee || 0);
                    const courses = parseFloat(newData.total_courses || 0);
                    const examRate = parseFloat(newData.exam_fee_per_subject || 0);
                    newData.tuition_fee = parseFloat(newData.tuition_fee) || (cr * rate);
                    newData.exam_fee = parseFloat(newData.exam_fee) || (courses * examRate);
                    newData.total_fee = newData.tuition_fee + newData.exam_fee + parseFloat(newData.reg_fee||0) + parseFloat(newData.other_fee||0);
                }
                if (modalType === 'payments' && !newData.name) {
                    const s = data.students.find(st => norm(st.reg_no) === norm(newData.reg_no));
                    if(s) newData.name = s.name;
                }

                setData(prev => {
                    const list = prev[modalType];
                    const existingIdx = list.findIndex(item => item.id === newData.id);
                    let updatedList;
                    if (existingIdx > -1) {
                        updatedList = [...list];
                        updatedList[existingIdx] = newData;
                    } else {
                        updatedList = [...list, newData];
                    }
                    return { ...prev, [modalType]: updatedList };
                });
                setShowModal(false);
                setFormData({});
                setEditingId(null);
            };

            const openModal = (type, item = null) => {
                setModalType(type);
                if (item) {
                    setFormData(item);
                    setEditingId(item.id);
                } else {
                    setFormData({});
                    setEditingId(null);
                }
                setShowModal(true);
            };

            // --- FILTER & BULK ---
            const getFilteredData = () => {
                if (!tabSearch) return data[activeTab];
                return data[activeTab].filter(item => 
                    Object.values(item).some(val => String(val).toLowerCase().includes(tabSearch.toLowerCase()))
                );
            };

            const handleSelectAll = (e) => {
                if (e.target.checked) setSelectedIds(new Set(getFilteredData().map(i => i.id)));
                else setSelectedIds(new Set());
            };

            const handleSelectRow = (id) => {
                const newSet = new Set(selectedIds);
                if (newSet.has(id)) newSet.delete(id);
                else newSet.add(id);
                setSelectedIds(newSet);
            };

            const deleteSelected = () => {
                if (selectedIds.size === 0) return;
                if (!confirm(`Delete ${selectedIds.size} records?`)) return;
                setData(prev => ({ ...prev, [activeTab]: prev[activeTab].filter(item => !selectedIds.has(item.id)) }));
                setSelectedIds(new Set());
            };

            const deleteAllInTab = () => {
                if (!confirm(`Permanently delete ALL ${activeTab} records?`)) return;
                setData(prev => ({ ...prev, [activeTab]: [] }));
                setSelectedIds(new Set());
            };

            const filteredData = getFilteredData();

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800 pb-20">
                    <div className="bg-white shadow-md border-b border-gray-200 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center gap-3">
                                    <div className="bg-blue-600 text-white p-2 rounded-lg"><BookOpen className="h-6 w-6" /></div>
                                    <div><h1 className="text-xl font-bold text-gray-900 leading-none">Fee Manager</h1><p className="text-xs text-gray-500">School of Accountancy & Finance</p></div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => window.print()} className="p-2 text-gray-500 hover:bg-gray-100 rounded-lg"><Printer className="h-5 w-5" /></button>
                                    <button onClick={() => {if(confirm('Clear ALL System Data?')) {localStorage.removeItem('feeSystemData_v2'); window.location.reload()}}} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 className="h-5 w-5" /></button>
                                </div>
                            </div>
                            <div className="flex space-x-1 overflow-x-auto no-scrollbar">
                                {[{id:'clearance',label:'Clearance',icon:FileText},{id:'students',label:'Students',icon:Users},{id:'fees',label:'Fee Structure',icon:DollarSign},{id:'enrollments',label:'Enrollments',icon:BookOpen},{id:'payments',label:'Payments',icon:CreditCard},{id:'discounts',label:'Discounts',icon:Percent}].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${activeTab === tab.id ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`}>
                                        <tab.icon className="h-4 w-4" />{tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {activeTab === 'clearance' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 no-print">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Generate Student Clearance</label>
                                    <div className="flex gap-3">
                                        <input type="text" value={searchReg} onChange={(e) => setSearchReg(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && generateReport()} placeholder="Enter Registration No (e.g. BSCAF052530040)" className="flex-1 block w-full rounded-lg border-gray-300 border p-3 focus:ring-2 focus:ring-blue-500 outline-none" />
                                        <button onClick={generateReport} className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2"><Search className="h-5 w-5" /> Generate</button>
                                    </div>
                                </div>
                                {clearanceResult && (
                                    <div className="bg-white rounded-xl shadow-lg overflow-hidden" id="printableArea">
                                        <div className="p-8">
                                            <div className="border-b-2 border-gray-800 pb-6 mb-6 flex justify-between items-start">
                                                <div className="w-24 h-24 rounded-lg flex items-center justify-center font-bold text-gray-400 overflow-hidden">
                                                    <img src="src/UOL-Green-V1.png" alt="UOL Logo" className="w-full h-full object-contain" />
                                                </div>
                                                <div className="text-center flex-1 px-4">
                                                    <h2 className="text-2xl font-bold text-gray-900 uppercase">The University of Lahore</h2>
                                                    <p className="text-gray-600 font-medium">School of Accountancy & Finance</p>
                                                    <div className="inline-block bg-gray-100 px-3 py-1 rounded mt-2 text-xs font-bold uppercase tracking-wider">Fee Clearance Report</div>
                                                </div>
                                                <div className="text-right text-xs text-gray-500"><p>Printed: {new Date().toLocaleString()}</p></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-x-12 gap-y-4 mb-8 text-sm">
                                                <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Registration No:</span><span className="font-mono font-bold text-gray-900">{clearanceResult.student.reg_no}</span></div>
                                                <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Student Name:</span><span className="text-gray-900">{clearanceResult.student.name}</span></div>
                                                <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Degree Program:</span><span className="text-gray-900">{clearanceResult.student.degree}</span></div>
                                                <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Batch / Session:</span><span className="text-gray-900">{clearanceResult.student.batch}</span></div>
                                            </div>
                                            {!clearanceResult.masterFeeFound && (
                                                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4"><p className="text-sm text-yellow-700"><strong>Warning:</strong> No matching Fee Structure found for {clearanceResult.student.degree} {clearanceResult.student.batch}.</p></div>
                                            )}
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-xs">
                                                    <thead className="bg-gray-100 text-gray-900 font-bold uppercase">
                                                        <tr><th className="p-2 border">Sem</th><th className="p-2 border text-center">Cr</th><th className="p-2 border text-right">Tuition</th><th className="p-2 border text-right">Exam</th><th className="p-2 border text-right">Misc</th><th className="p-2 border text-right bg-gray-50">Total</th><th className="p-2 border text-center">Schol.</th><th className="p-2 border text-right">Net Fee</th><th className="p-2 border text-right text-green-700">Paid</th><th className="p-2 border text-right">Balance</th></tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-200">
                                                        {clearanceResult.rows.map((row, idx) => (
                                                            <tr key={idx} className="hover:bg-gray-50">
                                                                <td className="p-2 border font-medium">{row.semester}</td>
                                                                <td className="p-2 border text-center">{row.cr}</td>
                                                                <td className="p-2 border text-right text-gray-600">{num(row.tuition)}</td>
                                                                <td className="p-2 border text-right text-gray-600">{num(row.exam)}</td>
                                                                <td className="p-2 border text-right text-gray-600">{num(row.reg + row.other)}</td>
                                                                <td className="p-2 border text-right font-bold bg-gray-50">{num(row.total)}</td>
                                                                <td className="p-2 border text-center text-gray-500">{row.discPct > 0 ? `${row.discPct}% (${num(row.discAmt)})` : '-'}</td>
                                                                <td className="p-2 border text-right font-bold">{num(row.netFee)}</td>
                                                                <td className="p-2 border text-right font-bold text-green-600">{num(row.totalPaid)}</td>
                                                                <td className={`p-2 border text-right font-bold ${row.balance > 0 ? 'text-red-600' : 'text-green-600'}`}>{num(row.balance)}</td>
                                                            </tr>
                                                        ))}
                                                        {clearanceResult.rows.length === 0 && <tr><td colSpan="10" className="p-4 text-center text-gray-400 italic">No enrollment records found.</td></tr>}
                                                        <tr className="bg-gray-800 text-white font-bold">
                                                            <td colSpan="5" className="p-3 text-right uppercase tracking-wider">Grand Totals</td>
                                                            <td className="p-3 text-right">{num(clearanceResult.summary.total)}</td>
                                                            <td className="p-3 text-center">-</td>
                                                            <td className="p-3 text-right">{num(clearanceResult.summary.total - clearanceResult.summary.fa)}</td>
                                                            <td className="p-3 text-right text-green-400">{num(clearanceResult.summary.paid)}</td>
                                                            <td className={`p-3 text-right ${clearanceResult.summary.balance > 0 ? 'text-red-400' : 'text-green-400'}`}>{num(clearanceResult.summary.balance)}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div className="mt-8 flex justify-end">
                                                <div className="w-64 bg-gray-50 p-4 rounded border border-gray-200">
                                                    <div className="flex justify-between text-sm mb-2"><span className="text-gray-600">Total Scholarship:</span><span className="font-bold text-green-600">{num(clearanceResult.summary.fa)}</span></div>
                                                    <div className="border-t border-gray-300 my-2"></div>
                                                    <div className="flex justify-between text-lg font-bold"><span>Net Payable:</span><span className="text-red-600">{num(clearanceResult.summary.balance)}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab !== 'clearance' && (
                            <div>
                                <div className="flex flex-col gap-4 mb-6">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-2xl font-bold text-gray-800 capitalize">{activeTab} Directory</h2>
                                        <button onClick={() => openModal(activeTab)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2 shadow-sm"><Plus className="h-5 w-5" /> Add New</button>
                                    </div>
                                    <div className="bg-white p-3 rounded-xl border border-gray-200 flex flex-wrap gap-3 items-center justify-between shadow-sm">
                                        <div className="relative flex-grow max-w-md">
                                            <Search className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                                            <input type="text" value={tabSearch} onChange={(e) => setTabSearch(e.target.value)} placeholder={`Filter ${activeTab}...`} className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                        <div className="flex gap-2">
                                            {selectedIds.size > 0 && <button onClick={deleteSelected} className="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-100 flex items-center gap-2 animate-pulse"><Trash2 className="h-4 w-4" /> Delete ({selectedIds.size})</button>}
                                            <button onClick={deleteAllInTab} className="bg-white border border-red-200 text-red-600 px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-50 flex items-center gap-2"><XSquare className="h-4 w-4" /> Delete All</button>
                                            <div className="h-8 w-px bg-gray-300 mx-1"></div>
                                            <button onClick={() => downloadSample(activeTab)} className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2"><FileSpreadsheet className="h-4 w-4" /> Sample</button>
                                            <label className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 cursor-pointer flex items-center gap-2"><Download className="h-4 w-4" /> Import<input type="file" onChange={(e) => handleImport(e, activeTab)} className="hidden" accept=".csv" /></label>
                                            <button onClick={() => handleExport(activeTab)} className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2"><Upload className="h-4 w-4" /> Export</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-gray-700 uppercase font-bold text-xs border-b border-gray-200">
                                                <tr>
                                                    <th className="p-4 w-10"><input type="checkbox" onChange={handleSelectAll} checked={filteredData.length > 0 && selectedIds.size === filteredData.length} className="rounded" /></th>
                                                    {activeTab === 'students' && <><th className="p-4">Reg No</th><th className="p-4">Name</th><th className="p-4">Degree</th><th className="p-4">Batch</th></>}
                                                    {activeTab === 'fees' && <><th className="p-4">Degree</th><th className="p-4">Batch</th><th className="p-4 text-right">Fee/Cr</th><th className="p-4 text-right">Fee/Sub</th></>}
                                                    {activeTab === 'enrollments' && <><th className="p-4">Reg No</th><th className="p-4">Name</th><th className="p-4">Semester</th><th className="p-4">Cr Hrs</th></>}
                                                    {activeTab === 'payments' && <><th className="p-4">Reg No</th><th className="p-4">Name</th><th className="p-4">Semester</th><th className="p-4 text-right">Amount</th></>}
                                                    {activeTab === 'discounts' && <><th className="p-4">Reg No</th><th className="p-4">Name</th><th className="p-4">Term</th><th className="p-4 text-right">Discount</th></>}
                                                    <th className="p-4 text-center">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {filteredData.map((item, idx) => (
                                                    <tr key={item.id || idx} className={`hover:bg-gray-50 transition ${selectedIds.has(item.id) ? 'bg-blue-50' : ''}`}>
                                                        <td className="p-4"><input type="checkbox" checked={selectedIds.has(item.id)} onChange={() => handleSelectRow(item.id)} className="rounded" /></td>
                                                        {activeTab === 'students' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4 font-bold">{item.name}</td><td className="p-4"><span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">{item.degree}</span></td><td className="p-4 text-gray-500">{item.batch}</td></>}
                                                        {activeTab === 'fees' && <><td className="p-4 font-bold">{item.degree}</td><td className="p-4 text-gray-600">{item.batch}</td><td className="p-4 text-right text-gray-500">{num(item.per_cr_fee)}</td><td className="p-4 text-right font-bold text-green-700">{num(item.per_course_fee)}</td></>}
                                                        {activeTab === 'enrollments' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4">{item.name}</td><td className="p-4"><span className="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs font-bold">{item.semester}</span></td><td className="p-4">{item.cr}</td></>}
                                                        {activeTab === 'payments' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4">{item.name}</td><td className="p-4"><span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">{item.semester}</span></td><td className="p-4 text-right font-bold">{num(item.amount)}</td></>}
                                                        {activeTab === 'discounts' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4">{item.name}</td><td className="p-4 text-gray-500">{item.term}</td><td className="p-4 text-right font-bold text-purple-600">{item.discount}%</td></>}
                                                        <td className="p-4 text-center flex justify-center gap-2">
                                                            <button onClick={() => openModal(activeTab, item)} className="p-2 text-blue-600 hover:bg-blue-50 rounded"><i className="fas fa-edit"></i> Edit</button>
                                                            <button onClick={() => handleDelete(activeTab, item.id)} className="p-2 text-red-600 hover:bg-red-50 rounded"><Trash2 className="h-4 w-4" /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {filteredData.length === 0 && <tr><td colSpan="7" className="p-8 text-center text-gray-400">No records found.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {showModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
                                <h3 className="text-xl font-bold mb-4 capitalize">Add/Edit {modalType.slice(0, -1)}</h3>
                                <form onSubmit={handleSave} className="space-y-4">
                                    {modalType === 'students' && <><input required placeholder="Registration No" className="w-full border p-2 rounded" value={formData.reg_no || ''} onChange={e => setFormData({...formData, reg_no: e.target.value})} /><input required placeholder="Full Name" className="w-full border p-2 rounded" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} /><div className="grid grid-cols-2 gap-4"><input placeholder="Degree (e.g. BSCAF)" className="w-full border p-2 rounded" value={formData.degree || ''} onChange={e => setFormData({...formData, degree: e.target.value})} /><input placeholder="Batch (e.g. Fall 2023)" className="w-full border p-2 rounded" value={formData.batch || ''} onChange={e => setFormData({...formData, batch: e.target.value})} /></div></>}
                                    {modalType === 'fees' && <><div className="bg-blue-50 p-3 rounded text-xs text-blue-800 mb-2"><strong>Note:</strong> Fee Structure applies to ALL semesters for this Degree & Batch.</div><div className="grid grid-cols-2 gap-4"><input required placeholder="Degree" className="w-full border p-2 rounded" value={formData.degree || ''} onChange={e => setFormData({...formData, degree: e.target.value})} /><input required placeholder="Batch" className="w-full border p-2 rounded" value={formData.batch || ''} onChange={e => setFormData({...formData, batch: e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><input type="number" placeholder="Fee Per Credit Hour" className="w-full border p-2 rounded" value={formData.per_cr_fee || ''} onChange={e => setFormData({...formData, per_cr_fee: e.target.value})} /><input type="number" placeholder="Fee Per Subject/Course" className="w-full border p-2 rounded" value={formData.per_course_fee || ''} onChange={e => setFormData({...formData, per_course_fee: e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><input type="number" placeholder="Registration Fee (Semester)" className="w-full border p-2 rounded" value={formData.reg_fee || ''} onChange={e => setFormData({...formData, reg_fee: e.target.value})} /><input type="number" placeholder="Other Charges (Semester)" className="w-full border p-2 rounded" value={formData.other_fee || ''} onChange={e => setFormData({...formData, other_fee: e.target.value})} /></div></>}
                                    {modalType === 'enrollments' && <><input required placeholder="Registration No" className="w-full border p-2 rounded" value={formData.reg_no || ''} onChange={e => setFormData({...formData, reg_no: e.target.value})} /><input placeholder="Student Name" className="w-full border p-2 rounded" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} /><input required placeholder="Semester (e.g. Spring 2024)" className="w-full border p-2 rounded" value={formData.semester || ''} onChange={e => setFormData({...formData, semester: e.target.value})} /><div className="grid grid-cols-2 gap-4"><input type="number" placeholder="Credit Hours" className="w-full border p-2 rounded" value={formData.cr || ''} onChange={e => setFormData({...formData, cr: e.target.value})} /><input type="number" placeholder="No. of Courses" className="w-full border p-2 rounded" value={formData.courses || ''} onChange={e => setFormData({...formData, courses: e.target.value})} /></div></>}
                                    {modalType === 'payments' && <><input required placeholder="Registration No" className="w-full border p-2 rounded" value={formData.reg_no || ''} onChange={e => setFormData({...formData, reg_no: e.target.value})} /><input required placeholder="Semester (e.g. Spring 2024)" className="w-full border p-2 rounded" value={formData.semester || ''} onChange={e => setFormData({...formData, semester: e.target.value})} /><input required type="number" placeholder="Amount Paid" className="w-full border p-2 rounded font-bold text-lg" value={formData.amount || ''} onChange={e => setFormData({...formData, amount: e.target.value})} /><input type="date" className="w-full border p-2 rounded" value={formData.date || ''} onChange={e => setFormData({...formData, date: e.target.value})} /></>}
                                    {modalType === 'discounts' && <><input required placeholder="Registration No" className="w-full border p-2 rounded" value={formData.reg_no || ''} onChange={e => setFormData({...formData, reg_no: e.target.value})} /><input required placeholder="Term (e.g. Spring 2024)" className="w-full border p-2 rounded" value={formData.term || ''} onChange={e => setFormData({...formData, term: e.target.value})} /><input required type="number" placeholder="Discount %" className="w-full border p-2 rounded" value={formData.discount || ''} onChange={e => setFormData({...formData, discount: e.target.value})} /></>}
                                    <div className="flex justify-end gap-3 mt-6">
                                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 font-bold">Cancel</button>
                                        <button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Save Record</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
