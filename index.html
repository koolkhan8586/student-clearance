<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSAF Student Fee Management</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- REACT & REACT DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- BABEL (To compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FONT & ICONS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Custom Scrollbar for a cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            @page {
                size: A4 portrait;
                margin: 5mm; 
            }
            
            /* RESET EVERYTHING FOR PRINT */
            html, body {
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                background: white !important;
                color: black !important;
            }

            /* Disable Fixed Positioning on Modals for Multi-page Print */
            .fixed, .absolute, .relative, .inset-0, .h-\[90vh\], .overflow-y-auto, .overflow-auto {
                position: static !important;
                overflow: visible !important;
                height: auto !important;
                width: auto !important;
                max-height: none !important;
            }

            /* HIDE EVERYTHING... */
            body * {
                visibility: hidden;
            }

            /* ...EXCEPT THE PRINT AREA */
            #printableArea, #printableArea * {
                visibility: visible;
            }

            /* POSITION THE PRINT AREA */
            #printableArea {
                position: absolute !important;
                left: 0;
                top: 0;
                width: 100% !important;
                height: auto !important; 
                margin: 0;
                padding: 0;
                background: white;
                font-family: 'Arial', sans-serif;
                font-size: 9px; 
                color: black;
                z-index: 9999;
                overflow: visible !important;
                display: block !important;
            }
            
            .no-print { display: none !important; }

            /* Force display for print headers even if hidden on screen */
            .print-only-header {
                display: block !important;
                visibility: visible !important;
            }
            
            /* TABLE STYLING FOR PRINT */
            table { 
                width: 100% !important; 
                border-collapse: collapse; 
            }
            
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            tr { page-break-inside: avoid; }

            th, td { 
                border: 1px solid #000 !important; 
                padding: 2px 3px !important; 
                overflow: hidden;
                white-space: normal; /* Allow wrapping */
                vertical-align: middle;
            }
            
            /* --- CLEARANCE REPORT SPECIFIC (13 Columns) --- */
            .clearance-table { table-layout: fixed; }
            .clearance-table th:nth-child(1), .clearance-table td:nth-child(1) { width: 14%; } /* Sem */
            .clearance-table th:nth-child(2), .clearance-table td:nth-child(2) { width: 4%; text-align: center; }  /* Sub */
            .clearance-table th:nth-child(3), .clearance-table td:nth-child(3) { width: 4%; text-align: center; }  /* Cr */
            .clearance-table th:nth-child(4), .clearance-table td:nth-child(4) { width: 8%; text-align: right; }  /* Tuition */
            .clearance-table th:nth-child(5), .clearance-table td:nth-child(5) { width: 6%; text-align: right; }  /* Exam */
            .clearance-table th:nth-child(6), .clearance-table td:nth-child(6) { width: 6%; text-align: right; }  /* Reg */
            .clearance-table th:nth-child(7), .clearance-table td:nth-child(7) { width: 6%; text-align: right; }  /* Other */
            .clearance-table th:nth-child(8), .clearance-table td:nth-child(8) { width: 9%; text-align: right; background-color: #f3f4f6 !important; font-weight: bold; } /* Total */
            .clearance-table th:nth-child(9), .clearance-table td:nth-child(9) { width: 5%; text-align: center; }  /* Disc % */
            .clearance-table th:nth-child(10), .clearance-table td:nth-child(10) { width: 7%; text-align: right; } /* D. Amt */
            .clearance-table th:nth-child(11), .clearance-table td:nth-child(11) { width: 9%; text-align: right; font-weight: bold; } /* Net */
            .clearance-table th:nth-child(12), .clearance-table td:nth-child(12) { width: 9%; text-align: right; } /* Paid */
            .clearance-table th:nth-child(13), .clearance-table td:nth-child(13) { width: 13%; text-align: right; font-weight: bold; } /* Balance */
            
            /* --- SESSION DETAIL REPORT SPECIFIC (11 Columns) --- */
            .session-detail-table { table-layout: fixed; }
            .session-detail-table th:nth-child(1), .session-detail-table td:nth-child(1) { width: 4%; text-align: center; } /* # */
            .session-detail-table th:nth-child(2), .session-detail-table td:nth-child(2) { width: 15%; font-family: monospace; } /* Reg No */
            .session-detail-table th:nth-child(3), .session-detail-table td:nth-child(3) { width: 20%; } /* Name */
            .session-detail-table th:nth-child(4), .session-detail-table td:nth-child(4) { width: 5%; text-align: center; } /* Courses */
            .session-detail-table th:nth-child(5), .session-detail-table td:nth-child(5) { width: 4%; text-align: center; } /* Cr */
            .session-detail-table th:nth-child(6), .session-detail-table td:nth-child(6) { width: 8%; text-align: right; } /* Tuition */
            .session-detail-table th:nth-child(7), .session-detail-table td:nth-child(7) { width: 8%; text-align: right; } /* Exam Fee */
            .session-detail-table th:nth-child(8), .session-detail-table td:nth-child(8) { width: 8%; text-align: right; } /* Discount */
            .session-detail-table th:nth-child(9), .session-detail-table td:nth-child(9) { width: 9%; text-align: right; font-weight: bold; } /* Total */
            .session-detail-table th:nth-child(10), .session-detail-table td:nth-child(10) { width: 9%; text-align: right; } /* Paid */
            .session-detail-table th:nth-child(11), .session-detail-table td:nth-child(11) { width: 10%; text-align: right; font-weight: bold; } /* Balance */

            /* Highlight Total */
            .print-modern-total {
                background-color: #000 !important;
                color: #fff !important;
                font-weight: 900 !important;
                border: 2px solid #000 !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }

            thead th {
                background-color: #e5e7eb !important;
                font-weight: 800;
                text-transform: uppercase;
                font-size: 8px;
                -webkit-print-color-adjust: exact;
            }
            
            /* Force Landscape for Summary Detail if needed */
            .landscape-mode-print {
                 /* @page { size: A4 landscape; } */
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const API_URL = 'api.php'; 

        // --- ICONS ---
        const Icon = ({ d, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>;
        const Search = (p) => <Icon d="M21 21l-4.35-4.35M19 11a8 8 0 1 1-16 0 8 8 0 0 1 16 0z" {...p} />;
        const Plus = (p) => <Icon d="M12 5v14M5 12h14" {...p} />;
        const Trash2 = (p) => <Icon d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...p} />;
        const FileText = (p) => <Icon d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" {...p} />;
        const Users = (p) => <Icon d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" {...p} />;
        const DollarSign = (p) => <Icon d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" {...p} />;
        const BookOpen = (p) => <Icon d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" {...p} />;
        const CreditCard = (p) => <Icon d="M1 4h22v16H1zM1 10h22" {...p} />;
        const Percent = (p) => <Icon d="M19 5L5 19M6.5 6.5h0M17.5 17.5h0" {...p} />;
        const Printer = (p) => <Icon d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z" {...p} />;
        const Download = (p) => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" {...p} />;
        const Upload = (p) => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" {...p} />;
        const FileSpreadsheet = (p) => <Icon d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" {...p} />;
        const XSquare = (p) => <Icon d="M3 3h18v18H3zM9 9l6 6M15 9l-6 6" {...p} />;
        const AlertCircle = (p) => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" {...p} />;
        const CalendarX = (p) => <Icon d="M3 4h18v18H3zM16 2v4M8 2v4M3 10h18" {...p} />;
        const LogOut = (p) => <Icon d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-12-5-7M21 12H9" {...p} />;
        const Shield = (p) => <Icon d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" {...p} />;
        const Key = (p) => <Icon d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" {...p} />;
        const CloudUpload = (p) => <Icon d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19a4 4 0 0 0 4 4h11a4 4 0 0 0 4-4v-2.5" {...p} />;
        const Landmark = (p) => <Icon d="M3 22v-8h18v8M12 2L2 7v3h20V7L12 2zM6 10v6M10 10v6M14 10v6M18 10v6" {...p} />;
        const Menu = (p) => <Icon d="M3 12h18M3 6h18M3 18h18" {...p} />;
        const BarChart = (p) => <Icon d="M12 20V10M18 20V4M6 20v-4" {...p} />;
        const Eye = (p) => <Icon d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 5c-3.866 0-7 3.134-7 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" {...p} />;

        function App() {
            // --- STATE & HELPER FUNCTIONS ---
            const norm = (str) => str ? str.toString().toLowerCase().replace(/[^a-z0-9]/g, '') : '';
            const num = (n) => parseFloat(n || 0).toLocaleString('en-US');
            
            const getTermRank = (sem) => {
                const s = (sem || '').toLowerCase();
                if(s.includes('fall')) return 1;
                if(s.includes('spring')) return 2;
                if(s.includes('summer')) return 3;
                return 4;
            };

            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('clearance');
            const [data, setData] = useState({
                students: [], fees: [], enrollments: [], payments: [], discounts: [], others: [], users: [], banks: []
            });
            const [searchReg, setSearchReg] = useState('');
            const [filterSession, setFilterSession] = useState(''); 
            const [summaryFilterSession, setSummaryFilterSession] = useState(''); 
            const [tabSearch, setTabSearch] = useState('');
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [clearanceResult, setClearanceResult] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({});
            const [loginData, setLoginData] = useState({ username: '', password: '' });
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [passwordData, setPasswordData] = useState({ current: '', new: '', confirm: '' });
            
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
            const [importPreview, setImportPreview] = useState({ show: false, total: 0, newItems: [], duplicates: [], type: '' });
            const [uploadStatus, setUploadStatus] = useState({ active: false, current: 0, total: 0 });
            const [importTerm, setImportTerm] = useState('');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [sessionDetail, setSessionDetail] = useState(null);

            const TABS = [
                { id: 'clearance', label: 'Clearance', icon: FileText },
                { id: 'summary', label: 'Summary', icon: BarChart }, 
                { id: 'students', label: 'Students', icon: Users },
                { id: 'fees', label: 'Fee Structure', icon: DollarSign },
                { id: 'others', label: 'Other Charges', icon: AlertCircle },
                { id: 'enrollments', label: 'Enrollments', icon: BookOpen },
                { id: 'payments', label: 'Payments', icon: CreditCard },
                { id: 'discounts', label: 'Discounts', icon: Percent },
                { id: 'banks', label: 'Banks', icon: Landmark } 
            ];

            const availableTabs = user ? (
                user.role === 'admin' 
                ? [...TABS, { id: 'users', label: 'Users & Access', icon: Shield }] 
                : TABS.filter(t => user.permissions.includes(t.id))
            ) : [];

            // FETCH DATA
            const refreshData = async () => {
                try {
                    const res = await fetch(API_URL);
                    const json = await res.json();
                    const safeData = {
                        students: Array.isArray(json.students) ? json.students : [],
                        fees: Array.isArray(json.fees) ? json.fees : [],
                        enrollments: Array.isArray(json.enrollments) ? json.enrollments : [],
                        payments: Array.isArray(json.payments) ? json.payments : [],
                        discounts: Array.isArray(json.discounts) ? json.discounts : [],
                        others: Array.isArray(json.others) ? json.others : [],
                        users: Array.isArray(json.users) ? json.users : [],
                        banks: Array.isArray(json.banks) ? json.banks : []
                    };
                    setData(safeData);
                } catch(e) { 
                    console.error("Connection Error:", e);
                    setData({ students: [], fees: [], enrollments: [], payments: [], discounts: [], others: [], users: [], banks: [] });
                }
            };

            useEffect(() => {
                refreshData();
                const storedUser = sessionStorage.getItem('feeUser');
                if(storedUser) setUser(JSON.parse(storedUser));
            }, []);

            useEffect(() => {
                setSelectedIds(new Set());
                setTabSearch('');
                setSortConfig({ key: null, direction: 'asc' }); 
                setImportTerm(''); 
                setSidebarOpen(false); 
            }, [activeTab]);

            useEffect(() => {
                if (activeTab === 'clearance' && searchReg && clearanceResult) {
                    generateReport();
                }
            }, [filterSession]);

            const getProcessedData = () => {
                let result = (data[activeTab] || []); 
                if (tabSearch) {
                    result = result.filter(item => Object.values(item).some(val => String(val || '').toLowerCase().includes(tabSearch.toLowerCase())));
                }
                if (sortConfig.key) {
                    result = [...result].sort((a, b) => {
                        let valA = a[sortConfig.key]?.toString().toLowerCase() || '';
                        let valB = b[sortConfig.key]?.toString().toLowerCase() || '';
                        const numA = parseFloat(valA); const numB = parseFloat(valB);
                        if (!isNaN(numA) && !isNaN(numB) && isFinite(valA) && isFinite(valB)) {
                             return sortConfig.direction === 'asc' ? numA - numB : numB - numA;
                        }
                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return result;
            };

            const filteredData = getProcessedData();
            
            // Unique Sessions
            const uniqueSessions = [...new Set((data.enrollments || []).map(e => e.semester))].sort((a, b) => {
                const yearA = parseInt(a.replace(/\D/g, '')) || 0;
                const yearB = parseInt(b.replace(/\D/g, '')) || 0;
                if (yearA !== yearB) return yearA - yearB;
                return getTermRank(a) - getTermRank(b);
            });
            
            // --- SUMMARY LOGIC ---
            const getSummaryData = useMemo(() => {
                if(activeTab !== 'summary') return [];
                const studentMap = new Map((data.students || []).map(s => [norm(s.reg_no), s]));
                const otherChargesMap = new Map();
                (data.others || []).forEach(o => {
                     const k = `${norm(o.reg_no)}_${norm(o.semester)}`;
                     otherChargesMap.set(k, (otherChargesMap.get(k) || 0) + (parseFloat(o.amount) || 0));
                });
                const discountMap = new Map();
                (data.discounts || []).forEach(d => {
                     const k = `${norm(d.reg_no)}_${norm(d.term)}`;
                     discountMap.set(k, parseFloat(d.discount) || 0);
                });
                const summary = new Map();
                const sessionDetailsMap = new Map();

                (data.enrollments || []).forEach(en => {
                    const sem = en.semester; 
                    const semKey = norm(sem);
                    if (summaryFilterSession && !semKey.includes(norm(summaryFilterSession))) return;
                    if(!summary.has(semKey)) {
                         summary.set(semKey, { session: sem, enrolled: new Set(), charged: 0, discount: 0, other: 0, paid: 0 });
                         sessionDetailsMap.set(semKey, []);
                    }
                    const entry = summary.get(semKey);
                    const detailList = sessionDetailsMap.get(semKey);

                    entry.enrolled.add(norm(en.reg_no));
                    
                    const student = studentMap.get(norm(en.reg_no));
                    let feeDetails = { total: 0, other: 0, tuition: 0, exam: 0 };
                    
                    if (student) {
                         let fee = data.fees.find(f => norm(f.degree) === norm(student.degree) && norm(f.batch) === norm(student.batch));
                         if(!fee) {
                            fee = data.fees.find(f => norm(f.degree) === norm(student.degree) && (
                                norm(student.batch).includes(norm(f.batch)) || norm(f.batch).includes(norm(student.batch))
                            ));
                         }
                         if (fee) {
                             const cr = parseFloat(en.cr || 0);
                             const courses = parseFloat(en.courses || 0);
                             const tuition = cr * parseFloat(fee.per_cr_fee || 0);
                             const exam = courses * parseFloat(fee.per_course_fee || 0);
                             const reg = parseFloat(fee.reg_fee || 0);
                             const otherBase = parseFloat(fee.other_fee || 0);
                             
                             feeDetails.tuition = tuition;
                             feeDetails.exam = exam; 
                             feeDetails.total = tuition + exam + reg + otherBase;
                             feeDetails.other = otherBase;
                         }
                    }
                    const specificOther = otherChargesMap.get(`${norm(en.reg_no)}_${semKey}`) || 0;
                    feeDetails.other += specificOther; 
                    feeDetails.total += specificOther;

                    const discPct = discountMap.get(`${norm(en.reg_no)}_${semKey}`) || 0;
                    const discAmt = (feeDetails.tuition * discPct) / 100;
                    
                    // Add Payment Calculation Per Student for Detail View
                    let studentPaid = 0;
                     (data.payments || []).forEach(p => {
                        if(norm(p.reg_no) === norm(en.reg_no)) {
                             const pSem = norm(p.semester);
                             if (pSem === semKey || (semKey.includes(pSem) && pSem.length > 3) || (pSem.includes(semKey) && semKey.length > 3)) {
                                studentPaid += parseFloat(p.amount || 0);
                             }
                        }
                    });

                    entry.charged += feeDetails.total;
                    entry.discount += discAmt;
                    entry.other += feeDetails.other;
                    
                    detailList.push({
                        reg_no: en.reg_no,
                        name: en.name,
                        courses: en.courses,
                        cr: en.cr,
                        tuition: feeDetails.tuition,
                        exam: feeDetails.exam, 
                        other: feeDetails.other,
                        discount: discAmt,
                        paid: studentPaid,
                        balance: (feeDetails.total - discAmt) - studentPaid
                    });
                });
                
                (data.payments || []).forEach(p => {
                    const pSem = norm(p.semester);
                    if (summaryFilterSession && !pSem.includes(norm(summaryFilterSession))) return;
                    let targetKey = null;
                    for (let key of summary.keys()) {
                        if (pSem === key || (key.includes(pSem) && pSem.length > 3) || (pSem.includes(key) && key.length > 3)) {
                            targetKey = key;
                            break;
                        }
                    }
                    if(targetKey) {
                        summary.get(targetKey).paid += parseFloat(p.amount || 0);
                    }
                });

                return Array.from(summary.values()).sort((a,b) => {
                     const yearA = parseInt(a.session.replace(/\D/g, '')) || 0;
                     const yearB = parseInt(b.session.replace(/\D/g, '')) || 0;
                     if (yearA !== yearB) return yearA - yearB;
                     return getTermRank(a.session) - getTermRank(b.session);
                }).map(s => ({
                    ...s,
                    enrolled: s.enrolled.size,
                    balance: (s.charged - s.discount) - s.paid,
                    details: sessionDetailsMap.get(norm(s.session)) || []
                }));
            }, [activeTab, data, summaryFilterSession]);

            // --- OPEN SESSION DETAIL ---
            const openSessionDetail = (sessionData) => {
                setSessionDetail(sessionData);
            };

            const paymentStats = activeTab === 'payments' ? filteredData.reduce((acc, item) => {
                 const amt = parseFloat(item.amount) || 0;
                 acc.total += amt;
                 const isBank = item.bank && item.bank !== 'Cash' && item.bank.trim() !== '';
                 if(isBank) acc.bank += amt;
                 else acc.cash += amt;
                 return acc;
            }, { total: 0, bank: 0, cash: 0 }) : { total: 0, bank: 0, cash: 0 };

            const postToApi = async (action, payload = {}) => {
                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action, ...payload })
                    });
                    const json = await res.json();
                    if(json.status === 'success') { refreshData(); return true; } 
                    else { alert("Error: " + json.message); return false; }
                } catch(e) { alert("Network Error"); return false; }
            };

            const syncBrowserDataToDb = async () => {
                if(!confirm("Sync browser data to database?")) return;
                const local = localStorage.getItem('feeSystemData_v2') || localStorage.getItem('fee_system_local');
                if(!local) return alert("No local data found.");
                const localData = JSON.parse(local);
                const categories = ['students', 'fees', 'enrollments', 'payments', 'discounts', 'others', 'banks'];
                let count = 0;
                setUploadStatus({ active: true, current: 0, total: 100 }); 
                for (const cat of categories) {
                     const items = localData[cat] || [];
                     for (const item of items) {
                         let actionType = cat.endsWith('s') ? cat.slice(0, -1) : cat;
                         if(cat === 'others') actionType = 'other';
                         await postToApi(`save_${actionType}`, { data: item });
                         count++;
                     }
                }
                setUploadStatus({ active: false, current: 0, total: 0 });
                alert(`Sync Complete! Uploaded/Checked ${count} records.`);
                refreshData();
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const userList = data.users || [];
                const found = userList.find(u => u.username === loginData.username && u.password === loginData.password);
                if (found) {
                    setUser(found);
                    sessionStorage.setItem('feeUser', JSON.stringify(found));
                    setLoginData({ username: '', password: '' });
                    if(found.role === 'admin' || found.permissions.includes('clearance')) setActiveTab('clearance');
                    else if(found.permissions.length > 0) setActiveTab(found.permissions[0]);
                } else { alert("Invalid Credentials"); }
            };

            const handleLogout = () => {
                setUser(null);
                sessionStorage.removeItem('feeUser');
                setClearanceResult(null);
                setActiveTab('clearance');
            };

            const handleChangePassword = async (e) => {
                e.preventDefault();
                if (passwordData.current !== user.password) return alert("Incorrect current password!");
                if (passwordData.new !== passwordData.confirm) return alert("New passwords do not match!");
                const success = await postToApi('save_user', { data: { ...user, password: passwordData.new }, id: user.id });
                if(success) {
                    alert("Password changed successfully!");
                    setShowPasswordModal(false);
                    setPasswordData({ current: '', new: '', confirm: '' });
                    const updatedUser = { ...user, password: passwordData.new };
                    setUser(updatedUser);
                    sessionStorage.setItem('feeUser', JSON.stringify(updatedUser));
                    refreshData();
                }
            };

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                setSortConfig({ key, direction });
            };

            const generateReport = () => {
                if (!searchReg) return;
                const cleanReg = norm(searchReg);
                const student = data.students?.find(s => norm(s.reg_no) === cleanReg);
                if (!student) { alert("Student not found!"); setClearanceResult(null); return; }
                
                let masterFee = data.fees?.find(f => norm(f.degree) === norm(student.degree) && norm(f.batch) === norm(student.batch));
                if (!masterFee) {
                    masterFee = data.fees?.find(f => norm(f.degree) === norm(student.degree) && (
                        norm(student.batch).includes(norm(f.batch)) || norm(f.batch).includes(norm(student.batch))
                    ));
                }
                
                let studentEnrollments = data.enrollments?.filter(e => norm(e.reg_no) === cleanReg);

                if (filterSession) {
                    const cleanSession = norm(filterSession);
                    studentEnrollments = studentEnrollments.filter(en => norm(en.semester).includes(cleanSession));
                }
                
                studentEnrollments = studentEnrollments.map(en => {
                    const enSem = norm(en.semester);
                    const cr = parseFloat(en.cr || 0);
                    const courses = parseFloat(en.courses || 0);
                    let feeDetails = { tuition: 0, exam: 0, reg: 0, other: 0, total: 0 };
                    
                    if (masterFee) {
                        feeDetails.tuition = cr * parseFloat(masterFee.per_cr_fee || 0);
                        feeDetails.exam = (courses * parseFloat(masterFee.per_course_fee || 0)) + parseFloat(masterFee.other_fee || 0); 
                        feeDetails.reg = 0; 
                        feeDetails.other = 0;
                    }
                    const otherCharges = data.others?.filter(o => norm(o.reg_no) === cleanReg && (norm(o.semester) === enSem || enSem.includes(norm(o.semester)))) || [];
                    const extraCharges = otherCharges.reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
                    
                    feeDetails.other += extraCharges;
                    feeDetails.total = feeDetails.tuition + feeDetails.exam + feeDetails.other;

                    const discRecord = data.discounts?.find(d => norm(d.reg_no) === cleanReg && norm(d.term) === enSem);
                    const discPct = discRecord ? parseFloat(discRecord.discount || 0) : 0;
                    const discAmt = (feeDetails.tuition * discPct) / 100;
                    
                    const netFee = feeDetails.total - discAmt;
                    
                    const payments = data.payments?.filter(p => {
                        if (norm(p.reg_no) !== cleanReg) return false;
                        const pSem = norm(p.semester);
                        return pSem === enSem || (enSem.includes(pSem) && pSem.length > 3) || (pSem.includes(enSem) && enSem.length > 3);
                    }) || [];
                    const totalPaid = payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
                    const balance = netFee - totalPaid;
                    return { ...en, ...feeDetails, discPct, discAmt, netFee, totalPaid, balance };
                }) || [];

                const summary = studentEnrollments.reduce((acc, curr) => ({
                    total: acc.total + curr.total, fa: acc.fa + curr.discAmt,
                    paid: acc.paid + curr.totalPaid, balance: acc.balance + curr.balance,
                    cr: acc.cr + (parseFloat(curr.cr) || 0), 
                    courses: acc.courses + (parseFloat(curr.courses) || 0)
                }), { total: 0, fa: 0, paid: 0, balance: 0, cr: 0, courses: 0 });

                setClearanceResult({ student, rows: studentEnrollments, summary, masterFeeFound: !!masterFee, masterFee });
            };

            const handleDelete = async (type, id) => {
                if(!confirm("Are you sure?")) return;
                await postToApi(`delete_${type}`, { id });
                refreshData();
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const newData = { ...formData };
                if (modalType === 'fees') {
                    const cr = parseFloat(newData.cr || 0); const rate = parseFloat(newData.per_cr_fee || 0);
                    const courses = parseFloat(newData.total_courses || 0); const examRate = parseFloat(newData.per_course_fee || 0);
                    newData.tuition_fee = cr * rate; newData.exam_fee = courses * examRate;
                    newData.total_fee = newData.tuition_fee + newData.exam_fee + parseFloat(newData.reg_fee||0) + parseFloat(newData.other_fee||0);
                }
                
                if ((modalType === 'payments' || modalType === 'others') && !newData.name) {
                    const s = data.students.find(st => norm(st.reg_no) === norm(newData.reg_no));
                    if(s) newData.name = s.name;
                }
                
                let actionType = modalType.slice(0, -1);
                if(modalType === 'others') actionType = 'other';
                const success = await postToApi(`save_${actionType}`, { data: newData, id: editingId });
                if(success) { setShowModal(false); setFormData({}); setEditingId(null); refreshData(); }
            };
            
            const openModal = (type, item = null) => {
                setModalType(type);
                if (item) { setFormData(item); setEditingId(item.id || item.reg_no); } 
                else { setFormData(type==='users' ? {role:'user',permissions:[]} : {}); setEditingId(null); }
                setShowModal(true);
            };

            // NEW: Auto-populate name on Reg No Change
            const handleRegChange = (e) => {
                const reg = e.target.value;
                const student = data.students.find(s => norm(s.reg_no) === norm(reg));
                setFormData(prev => ({
                    ...prev, 
                    reg_no: reg,
                    name: student ? student.name : ''
                }));
            };

            // --- IMPORT HANDLER ---
            const handleImport = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const text = evt.target.result;
                    const rows = text.split('\n').map(r => r.trim()).filter(r => r);
                    if (rows.length < 2) return; 
                    const headers = rows[0].split(',').map(h => h.trim().replace(/ /g, '_').toLowerCase());
                    
                    const existingData = data[type] || [];
                    const newItems = [];
                    const duplicates = [];
                    
                    for (let i = 1; i < rows.length; i++) {
                        const values = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        const obj = {};
                        
                        // Smart Header Mapping
                        headers.forEach((h, index) => {
                            let val = values[index] ? values[index].trim() : '';
                            if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                            
                            // Map CSV headers to internal keys
                            if (h.includes('reg') && h.includes('no')) obj['reg_no'] = val;
                            else if ((h.includes('fee') || h.includes('charge') || h.includes('head')) && (h.includes('name') || h.includes('head'))) obj['fee_name'] = val; 
                            else if (h.includes('name') && !h.includes('user') && !h.includes('fee') && !h.includes('head')) obj['name'] = val; 
                            else if (h.includes('semester')) obj['semester'] = val;
                            else if (h.includes('amount')) obj['amount'] = val;
                            else if (h === 'cr') obj['cr'] = val;
                            else if (h.includes('course')) obj['courses'] = val;
                            else if (h.includes('degree')) obj['degree'] = val;
                            else if (h.includes('batch')) obj['batch'] = val;
                            else if (h.includes('term')) obj['term'] = val;
                            else if (h.includes('fee') && h.includes('name')) obj['fee_name'] = val;
                            else if (h.includes('bank')) obj['bank'] = val;
                            else if (h.includes('mobile')) obj['mobile'] = val;
                            else if (h.includes('email')) obj['email'] = val;
                            else obj[h] = val; 
                        });

                        if(importTerm) {
                            if(type === 'enrollments' || type === 'payments' || type === 'others') obj.semester = importTerm;
                            else if(type === 'discounts') obj.term = importTerm;
                        }
                        if (obj.amount) obj.amount = obj.amount.replace(/[^0-9.-]/g, '');

                        // AUTO-FILL NAME FROM DIRECTORY (UPDATED)
                        if (!obj.name && obj.reg_no) {
                            const student = data.students.find(s => norm(s.reg_no) === norm(obj.reg_no));
                            if (student) obj.name = student.name;
                        }

                        let isDuplicate = false;
                        if (type === 'payments') {
                             isDuplicate = existingData.some(existing => 
                                norm(existing.reg_no) === norm(obj.reg_no) &&
                                Math.abs(parseFloat(existing.amount || 0) - parseFloat(obj.amount || 0)) < 0.01 && 
                                existing.date === obj.date && 
                                norm(existing.bank) === norm(obj.bank)
                            );
                        } else if (type === 'students') {
                             isDuplicate = existingData.some(existing => norm(existing.reg_no) === norm(obj.reg_no));
                        } else if (type === 'fees') {
                             isDuplicate = existingData.some(existing => norm(existing.degree) === norm(obj.degree) && norm(existing.batch) === norm(obj.batch));
                        } else {
                             isDuplicate = existingData.some(existing => 
                                norm(existing.reg_no) === norm(obj.reg_no) &&
                                ((existing.semester && norm(existing.semester) === norm(obj.semester)) ||
                                (existing.term && norm(existing.term) === norm(obj.term)))
                             );
                        }
                        
                        if (isDuplicate) duplicates.push(obj);
                        else newItems.push(obj);
                    }
                    
                    setImportPreview({ show: true, total: rows.length - 1, newItems, duplicates, type });
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            const confirmImport = async () => {
                setUploadStatus({ active: true, current: 0, total: importPreview.newItems.length });
                let actionType = importPreview.type.slice(0, -1);
                if(importPreview.type === 'others') actionType = 'other';
                let uploadedCount = 0;
                for (const item of importPreview.newItems) {
                    await postToApi(`save_${actionType}`, { data: item });
                    uploadedCount++;
                    setUploadStatus(prev => ({ ...prev, current: uploadedCount }));
                }
                setImportPreview({ show: false, total: 0, newItems: [], duplicates: [], type: '' });
                setUploadStatus({ active: false, current: 0, total: 0 });
                alert(`Successfully imported ${uploadedCount} records!`);
                refreshData();
            };

            // --- FILTER & BULK ---
            const handleSelectAll = (e) => {
                if (e.target.checked) setSelectedIds(new Set(filteredData.map(i => i.id || i.reg_no)));
                else setSelectedIds(new Set());
            };
            const handleSelectRow = (id) => {
                const newSet = new Set(selectedIds);
                if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                setSelectedIds(newSet);
            };
            const deleteSelected = async () => {
                if (!confirm(`Delete ${selectedIds.size} records?`)) return;
                for (let id of selectedIds) {
                    let type = activeTab;
                    if(type === 'others') type = 'other'; 
                    await postToApi(`delete_${type.slice(0,-1)}`, { id });
                }
                setSelectedIds(new Set());
                refreshData();
            };
            const deleteAllInTab = async () => {
                if (!confirm(`Permanently delete ALL ${activeTab} records?`)) return;
                await postToApi('delete_all', { table: activeTab });
                refreshData();
            };
            const deleteBySemester = async () => {
                const term = prompt("Enter Semester Name to delete:");
                if (!term) return;
                await postToApi('delete_semester', { table: activeTab, term });
                refreshData();
            };

            const togglePermission = (tabId) => {
                const perms = formData.permissions || [];
                if (perms.includes(tabId)) setFormData({ ...formData, permissions: perms.filter(p => p !== tabId) });
                else setFormData({ ...formData, permissions: [...perms, tabId] });
            };
            
            const getHeaders = (type) => {
                switch(type) {
                    case 'students': return ['reg_no', 'name', 'degree', 'batch', 'mobile', 'email'];
                    case 'fees': return ['degree', 'batch', 'per_cr_fee', 'per_course_fee', 'reg_fee', 'other_fee'];
                    case 'enrollments': return ['reg_no', 'name', 'semester', 'cr', 'courses'];
                    case 'payments': return ['reg_no', 'name', 'semester', 'amount', 'date', 'bank'];
                    case 'discounts': return ['reg_no', 'name', 'term', 'discount'];
                    case 'others': return ['reg_no', 'name', 'semester', 'fee_name', 'amount']; 
                    case 'users': return ['username', 'password', 'role', 'permissions']; 
                    case 'banks': return ['name', 'account_no'];
                    default: return [];
                }
            };
            
            const downloadSample = (type) => {
                const headers = getHeaders(type);
                const displayHeaders = headers.map(h => h === 'fee_name' ? 'fee_head' : h); 
                const csvContent = "data:text/csv;charset=utf-8," + displayHeaders.join(",");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${type}_sample.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleExport = (type) => {
                const records = (type === activeTab) ? filteredData : data[type];
                if (!records || records.length === 0) return alert("No data to export");
                let headers = getHeaders(type);
                let displayHeaders = headers.map(h => h === 'fee_name' ? 'fee_head' : h);

                const csvRows = [
                    displayHeaders.join(','),
                    ...records.map(row => headers.map(fieldName => {
                        let val = row[fieldName];
                        if (Array.isArray(val)) val = val.join('|'); 
                        val = String(val || '');
                        if (val.search(/("|,|\n)/g) >= 0) {
                            val = `"${val.replace(/"/g, '""')}"`;
                        }
                        return val;
                    }).join(','))
                ];
                
                const csvString = csvRows.join("\n");
                
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `${type}_export_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
            };
            
            // --- VIEW ---
            if (!user) {
                return (
                    <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
                            <div className="flex justify-center mb-6">
                                <div className="w-24 h-24 rounded-lg flex items-center justify-center bg-white p-2">
                                     <img src="src/UOL-Green-V1.png" alt="UOL Logo" className="w-full h-full object-contain" />
                                </div>
                            </div>
                            <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">LSAF Student Fee Management Software</h2>
                            <p className="text-center text-gray-500 mb-6">Secure Login</p>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div><label className="block text-sm font-bold text-gray-700 mb-1">Username</label><input type="text" value={loginData.username} onChange={e => setLoginData({...loginData, username: e.target.value})} className="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                <div><label className="block text-sm font-bold text-gray-700 mb-1">Password</label><input type="password" value={loginData.password} onChange={e => setLoginData({...loginData, password: e.target.value})} className="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition">Sign In</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-gray-100 font-sans text-gray-800 overflow-hidden">
                     {/* Left Sidebar */}
                     <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-xl border-r border-gray-200 h-full flex flex-col no-print transition-transform duration-300 ease-in-out md:relative md:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        {/* Header Section */}
                        <div className="p-6 border-b border-gray-200 bg-gray-50">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="bg-blue-600 text-white p-2 rounded-lg shadow-sm"><BookOpen className="h-6 w-6" /></div>
                                <div><h1 className="text-lg font-bold text-gray-900 leading-tight">Fee Manager</h1><p className="text-xs text-gray-500 font-medium">SCS & Finance</p></div>
                            </div>
                            <div className="flex flex-col gap-2">
                                <div className="text-sm font-bold text-gray-800">{user.username}</div>
                                <div className="text-xs text-gray-500 uppercase tracking-wide bg-gray-200 px-2 py-0.5 rounded w-fit">{user.role}</div>
                            </div>
                        </div>
                        
                        {/* Navigation */}
                        <div className="flex-1 overflow-y-auto py-4">
                            <nav className="space-y-1 px-3">
                                {availableTabs.map(tab => (
                                    <div key={tab.id}>
                                        <button 
                                            onClick={() => setActiveTab(tab.id)} 
                                            className={`w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 ${
                                                activeTab === tab.id 
                                                ? 'bg-blue-50 text-blue-700 border border-blue-100 shadow-sm' 
                                                : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                                            }`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400'}`}>
                                                    <tab.icon className="h-5 w-5" />
                                                </div>
                                                {tab.label}
                                            </div>
                                            
                                            {/* Total Count Badge: Dynamic update based on filter */}
                                            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${
                                                activeTab === tab.id ? 'bg-blue-200 text-blue-800' : 'bg-gray-200 text-gray-600'
                                            }`}>
                                                {tab.id === 'clearance' ? '-' : (activeTab === tab.id ? filteredData.length : (data[tab.id]?.length || 0))}
                                            </span>
                                        </button>
                                    </div>
                                ))}
                            </nav>
                        </div>

                        {/* Footer Actions */}
                        <div className="p-4 border-t border-gray-200 bg-gray-50 space-y-2">
                            <button onClick={syncBrowserDataToDb} className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition shadow-sm" title="Sync Data"><CloudUpload className="h-4 w-4" /> Sync Data</button>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => setShowPasswordModal(true)} className="flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-700 hover:bg-gray-100 transition shadow-sm"><Key className="h-3 w-3" /> Password</button>
                                <button onClick={handleLogout} className="flex items-center justify-center gap-2 px-3 py-2 bg-red-50 border border-red-200 rounded-lg text-xs font-medium text-red-600 hover:bg-red-100 transition shadow-sm"><LogOut className="h-3 w-3" /> Logout</button>
                            </div>
                        </div>
                    </div>

                    {/* Main Content Area - Right Side */}
                    <div className="flex-1 flex flex-col h-full relative overflow-hidden">
                        {/* Mobile Header Toggle */}
                        <div className="md:hidden bg-white border-b p-4 flex items-center justify-between no-print">
                            <button onClick={() => setSidebarOpen(true)} className="p-2 text-gray-600 rounded-lg hover:bg-gray-100">
                                <Menu className="h-6 w-6" />
                            </button>
                            <span className="font-bold text-gray-700">Student Fee System</span>
                            <div className="w-10"></div> {/* Spacer balance */}
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8" id="main-content">
                            {/* ... Clearance Tab (unchanged) ... */}
                            {activeTab === 'clearance' && (
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 no-print">
                                        <label className="block text-sm font-bold text-gray-700 mb-2">Generate Student Clearance</label>
                                        <div className="flex gap-3">
                                            <input type="text" value={searchReg} onChange={(e) => setSearchReg(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && generateReport()} placeholder="Enter Registration No (e.g. BSCAF052530040)" className="flex-1 block w-full rounded-lg border-gray-300 border p-3 focus:ring-2 focus:ring-blue-500 outline-none" />
                                            {/* SESSION FILTER */}
                                            <select 
                                                value={filterSession} 
                                                onChange={(e) => setFilterSession(e.target.value)} 
                                                className="w-48 rounded-lg border-gray-300 border p-3 focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                            >
                                                <option value="">All Sessions</option>
                                                {uniqueSessions.map(s => <option key={s} value={s}>{s}</option>)}
                                            </select>
                                            <button onClick={generateReport} className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2"><Search className="h-5 w-5" /> Generate</button>
                                        </div>
                                    </div>
                                    {/* ... Clearance Result (unchanged) ... */}
                                    {clearanceResult && (
                                        <div className="bg-white rounded-xl shadow-lg overflow-hidden" id="printableArea">
                                            <div className="p-8">
                                                <div className="border-b-2 border-gray-800 pb-6 mb-6 flex justify-between items-start">
                                                    <div className="w-32 h-32 rounded-lg flex items-center justify-center font-bold text-gray-400 overflow-hidden"><img src="src/UOL-Green-V1.png" alt="UOL Logo" className="w-full h-full object-contain" /></div>
                                                    <div className="text-center flex-1 px-4">
                                                        <h2 className="text-2xl font-bold text-gray-900 uppercase">The University of Lahore</h2>
                                                        <p className="text-gray-600 font-medium">School of Accountancy & Finance</p>
                                                        <div className="inline-block bg-gray-100 px-3 py-1 rounded mt-2 text-xs font-bold uppercase tracking-wider">Fee Clearance Report</div>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-x-12 gap-y-4 mb-8 text-sm">
                                                    <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Registration No:</span><span className="font-mono font-bold text-gray-900">{clearanceResult.student.reg_no}</span></div>
                                                    <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Student Name:</span><span className="text-gray-900">{clearanceResult.student.name}</span></div>
                                                    <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Degree Program:</span><span className="text-gray-900">{clearanceResult.student.degree}</span></div>
                                                    <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Batch / Session:</span><span className="text-gray-900">{clearanceResult.student.batch}</span></div>
                                                    <div className="flex justify-between border-b border-gray-200 py-1"><span className="font-bold text-gray-600">Rate (Per Cr. Hr):</span><span className="text-gray-900">{clearanceResult.masterFee ? num(clearanceResult.masterFee.per_cr_fee) : '-'}</span></div>
                                                </div>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-xs clearance-table">
                                                        <thead className="bg-gray-100 text-gray-900 font-bold uppercase">
                                                            <tr><th className="p-2 border">Sem</th><th className="p-2 border text-center">Sub</th><th className="p-2 border text-center">Cr</th><th className="p-2 border text-right">Tuition</th><th className="p-2 border text-right">Exam</th><th className="p-2 border text-right">Reg</th><th className="p-2 border text-right">Other</th><th className="p-2 border text-right bg-gray-50">Total</th><th className="p-2 border text-center">Disc %</th><th className="p-2 border text-right">D. Amt</th><th className="p-2 border text-right">Net</th><th className="p-2 border text-right text-green-700">Paid</th><th className="p-2 border text-right">Balance</th></tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-200">
                                                            {clearanceResult.rows.map((row, idx) => (
                                                                <tr key={idx} className="hover:bg-gray-50">
                                                                    <td className="p-2 border font-medium">{row.semester}</td><td className="p-2 border text-center">{row.courses}</td><td className="p-2 border text-center">{row.cr}</td><td className="p-2 border text-right text-gray-600">{num(row.tuition)}</td><td className="p-2 border text-right text-gray-600">{num(row.exam)}</td><td className="p-2 border text-right text-gray-600">{num(row.reg)}</td><td className="p-2 border text-right text-gray-600">{num(row.other)}</td><td className="p-2 border text-right font-bold bg-gray-50">{num(row.total)}</td><td className="p-2 border text-center text-gray-500">{row.discPct > 0 ? `${row.discPct}%` : '-'}</td><td className="p-2 border text-right text-gray-500">{row.discAmt > 0 ? num(row.discAmt) : '-'}</td><td className="p-2 border text-right font-bold">{num(row.netFee)}</td><td className="p-2 border text-right font-bold text-green-600">{num(row.totalPaid)}</td><td className={`p-2 border text-right font-bold ${row.balance > 0 ? 'text-red-600' : 'text-green-600'}`}>{num(row.balance)}</td>
                                                                </tr>
                                                            ))}
                                                            <tr className="bg-gray-800 text-white font-bold"><td className="p-3 text-right uppercase tracking-wider">Totals</td><td className="p-3 text-center">{clearanceResult.summary.courses}</td><td className="p-3 text-center">{clearanceResult.summary.cr}</td><td colSpan="4" className="p-3"></td><td className="p-3 text-right print-modern-total">{num(clearanceResult.summary.total)}</td><td className="p-3 text-center">-</td><td className="p-3 text-right">{num(clearanceResult.summary.fa)}</td><td className="p-3 text-right">{num(clearanceResult.summary.total - clearanceResult.summary.fa)}</td><td className="p-3 text-right text-green-400">{num(clearanceResult.summary.paid)}</td><td className={`p-3 text-right ${clearanceResult.summary.balance > 0 ? 'text-red-400' : 'text-green-400'}`}>{num(clearanceResult.summary.balance)}</td></tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div className="mt-4 flex justify-between items-end">
                                                    <div className="text-xs text-gray-500"><p>Printed by: <span className="font-bold text-gray-800">{user.username}</span></p><p>Time: {new Date().toLocaleString('en-US', { timeZone: 'Asia/Karachi' })}</p></div>
                                                    <div className="w-64 bg-gray-50 p-4 rounded border border-gray-200"><div className="flex justify-between text-sm mb-2"><span className="text-gray-600">Total Scholarship:</span><span className="font-bold text-green-600">{num(clearanceResult.summary.fa)}</span></div><div className="border-t border-gray-300 my-2"></div><div className="flex justify-between text-lg font-bold"><span>Net Payable:</span><span className="text-red-600">{num(clearanceResult.summary.balance)}</span></div></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'summary' && (
                                <div className="landscape-mode-print">
                                    <h2 className="text-2xl font-bold text-gray-800 capitalize mb-6">Financial Summary</h2>
                                    <div className="flex items-center gap-3 mb-4 no-print">
                                        <label className="font-medium text-sm">Filter Semester:</label>
                                        <select 
                                            value={summaryFilterSession} 
                                            onChange={(e) => setSummaryFilterSession(e.target.value)} 
                                            className="w-48 rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm"
                                        >
                                            <option value="">All Semesters</option>
                                            {uniqueSessions.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                        <button onClick={() => window.print()} className="p-2 text-gray-500 hover:bg-gray-100 rounded-lg" title="Print Summary"><Printer className="h-5 w-5" /></button>
                                    </div>
                                    {/* Use conditional ID to prevent double printing */}
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden" id={!sessionDetail ? "printableArea" : ""}>
                                        <div className="p-4 hidden print-only">
                                            <h2 className="text-xl font-bold text-center uppercase mb-4">Financial Summary Report</h2>
                                            {summaryFilterSession && <p className="text-center text-sm mb-4">Filter: {summaryFilterSession}</p>}
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left summary-table">
                                                <thead className="bg-gray-50 text-gray-700 uppercase font-bold text-xs border-b border-gray-200">
                                                    <tr>
                                                        <th className="p-4">Session</th>
                                                        <th className="p-4 text-center">Enrolled</th>
                                                        <th className="p-4 text-right">Total Charged</th>
                                                        <th className="p-4 text-right">Discounts</th>
                                                        <th className="p-4 text-right">Other Charges</th>
                                                        <th className="p-4 text-right">Total Paid</th>
                                                        <th className="p-4 text-right">Balance</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {getSummaryData.map((row, idx) => (
                                                        <tr key={idx} className="hover:bg-gray-50 transition cursor-pointer" onClick={() => openSessionDetail(row)}>
                                                            <td className="p-4 font-bold text-blue-600 hover:text-blue-800 flex items-center gap-2">
                                                                <Eye className="h-4 w-4" /> {row.session}
                                                            </td>
                                                            <td className="p-4 text-center"><span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">{row.enrolled}</span></td>
                                                            <td className="p-4 text-right font-mono font-bold text-gray-800">{num(row.charged)}</td>
                                                            <td className="p-4 text-right font-mono text-orange-600">{num(row.discount)}</td>
                                                            <td className="p-4 text-right font-mono text-gray-600">{num(row.other)}</td>
                                                            <td className="p-4 text-right font-mono font-bold text-green-600">{num(row.paid)}</td>
                                                            <td className={`p-4 text-right font-mono font-bold ${row.balance > 0 ? 'text-red-600' : 'text-green-600'}`}>{num(row.balance)}</td>
                                                        </tr>
                                                    ))}
                                                    {getSummaryData.length === 0 && <tr><td colSpan="7" className="p-8 text-center text-gray-400">No session data available.</td></tr>}
                                                    {getSummaryData.length > 0 && (
                                                        <tr className="bg-gray-800 text-white font-bold">
                                                            <td className="p-4">TOTALS</td>
                                                            <td className="p-4 text-center">{getSummaryData.reduce((s, r) => s + r.enrolled, 0)}</td>
                                                            <td className="p-4 text-right">{num(getSummaryData.reduce((s, r) => s + r.charged, 0))}</td>
                                                            <td className="p-4 text-right">{num(getSummaryData.reduce((s, r) => s + r.discount, 0))}</td>
                                                            <td className="p-4 text-right">{num(getSummaryData.reduce((s, r) => s + r.other, 0))}</td>
                                                            <td className="p-4 text-right text-green-400">{num(getSummaryData.reduce((s, r) => s + r.paid, 0))}</td>
                                                            <td className="p-4 text-right text-red-400">{num(getSummaryData.reduce((s, r) => s + r.balance, 0))}</td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab !== 'clearance' && activeTab !== 'summary' && (
                                <div>
                                    {/* (Existing List View UI same as before) */}
                                    <div className="flex flex-col gap-4 mb-6 no-print">
                                        <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800 capitalize">{activeTab} Directory</h2><div className="flex gap-2">{(user.role === 'admin' || user.permissions.includes(activeTab)) && <button onClick={() => openModal(activeTab)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2 shadow-sm"><Plus className="h-5 w-5" /> Add New</button>}</div></div>
                                        <div className="bg-white p-3 rounded-xl border border-gray-200 flex flex-wrap gap-3 items-center justify-between shadow-sm">
                                            
                                            {/* SEARCH / FILTER AREA */}
                                            <div className="relative flex-grow max-w-md flex items-center gap-2">
                                                <div className="relative flex-grow">
                                                    <Search className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                                                    <input type="text" value={tabSearch} onChange={(e) => setTabSearch(e.target.value)} placeholder={`Filter ${activeTab}...`} className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                                </div>
                                                {/* VISIBLE COUNT BADGE */}
                                                <span className="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">Showing {filteredData.length} Records</span>
                                            </div>

                                            <div className="flex gap-2">
                                                {selectedIds.size > 0 && <button onClick={deleteSelected} className="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-100 flex items-center gap-2"><Trash2 className="h-4 w-4" /> Delete ({selectedIds.size})</button>}
                                                {(activeTab === 'enrollments' || activeTab === 'payments' || activeTab === 'others') && <button onClick={deleteBySemester} className="bg-orange-50 border border-orange-200 text-orange-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-orange-100 flex items-center gap-2"><CalendarX className="h-4 w-4" /> Del Sem</button>}
                                                {user.role === 'admin' && <button onClick={deleteAllInTab} className="bg-white border border-red-200 text-red-600 px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-50 flex items-center gap-2"><XSquare className="h-4 w-4" /> Delete All</button>}
                                                <div className="h-8 w-px bg-gray-300 mx-1"></div>
                                                <button onClick={() => downloadSample(activeTab)} className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2"><FileSpreadsheet className="h-4 w-4" /> Sample</button>
                                                <label className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 cursor-pointer flex items-center gap-2"><Download className="h-4 w-4" /><input type="file" onChange={(e) => handleImport(e, activeTab)} className="hidden" accept=".csv" /></label>
                                                <button onClick={() => handleExport(activeTab)} className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2"><Upload className="h-4 w-4" /> Export</button>
                                            </div>
                                        </div>
                                        
                                        {/* TERM INPUT FOR IMPORT */}
                                        {(activeTab === 'enrollments' || activeTab === 'payments' || activeTab === 'others' || activeTab === 'discounts') && (
                                            <div className="bg-blue-50 border-l-4 border-blue-400 p-2 mb-4 text-sm flex items-center gap-2 no-print">
                                                <span className="font-bold">Import Setting:</span>
                                                <input type="text" placeholder="Default Semester/Term (e.g. Fall 2024)" value={importTerm} onChange={(e) => setImportTerm(e.target.value)} className="border p-1 rounded px-2 w-64" />
                                                <span className="text-gray-500 text-xs">(If provided, this will be applied to all imported records)</span>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* DASHBOARD WIDGETS FOR PAYMENTS */}
                                    {activeTab === 'payments' && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
                                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                                                <div className="text-xs font-bold text-gray-500 uppercase">Total Received</div>
                                                <div className="text-2xl font-bold text-gray-800">{num(paymentStats.total)}</div>
                                                <div className="text-xs text-green-600 mt-1">Based on current filter</div>
                                            </div>
                                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                                                <div className="text-xs font-bold text-gray-500 uppercase">JT Branch</div>
                                                <div className="text-2xl font-bold text-gray-800">{num(paymentStats.bank)}</div>
                                            </div>
                                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                                                <div className="text-xs font-bold text-gray-500 uppercase">Other Bank</div>
                                                <div className="text-2xl font-bold text-gray-800">{num(paymentStats.cash)}</div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-50 text-gray-700 uppercase font-bold text-xs border-b border-gray-200">
                                                    <tr><th className="p-4 w-10"><input type="checkbox" onChange={handleSelectAll} checked={filteredData.length > 0 && selectedIds.size === filteredData.length} className="rounded" /></th>{getHeaders(activeTab).map(h => <th key={h} className="p-4">{h.replace(/_/g, ' ')}</th>)}<th className="p-4 text-center">Actions</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {filteredData.map((item, idx) => (
                                                        <tr key={item.id || idx} className={`hover:bg-gray-50 transition ${selectedIds.has(item.id || item.reg_no) ? 'bg-blue-50' : ''}`}>
                                                            <td className="p-4"><input type="checkbox" checked={selectedIds.has(item.id || item.reg_no)} onChange={() => handleSelectRow(item.id || item.reg_no)} className="rounded" /></td>
                                                            {/* TABLE ROWS - Keep same structure as before */}
                                                            {activeTab === 'students' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4 font-bold">{item.name}</td><td className="p-4"><span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">{item.degree}</span></td><td className="p-4 text-gray-500">{item.batch}</td><td className="p-4 text-gray-500">{item.mobile || '-'}</td><td className="p-4 text-gray-500">{item.email || '-'}</td></>}
                                                            {activeTab === 'fees' && <><td className="p-4 font-bold">{item.degree}</td><td className="p-4 text-gray-600">{item.batch}</td><td className="p-4 text-right text-gray-500">{num(item.per_cr_fee)}</td><td className="p-4 text-right font-bold text-green-700">{num(item.per_course_fee)}</td><td className="p-4 text-right text-gray-500">{num(item.reg_fee)}</td><td className="p-4 text-right text-gray-500">{num(item.other_fee)}</td></>}
                                                            {activeTab === 'enrollments' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4">{item.name}</td><td className="p-4"><span className="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs font-bold">{item.semester}</span></td><td className="p-4">{item.cr}</td><td className="p-4">{item.courses}</td></>}
                                                            {activeTab === 'payments' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4">{item.name}</td><td className="p-4"><span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">{item.semester}</span></td><td className="p-4 text-right font-bold">{num(item.amount)}</td><td className="p-4 text-gray-500">{item.date}</td><td className="p-4 text-gray-500">{item.bank}</td></>}
                                                            {activeTab === 'others' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4">{item.name}</td><td className="p-4 text-gray-600">{item.semester}</td><td className="p-4"><span className="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs font-bold">{item.fee_name}</span></td><td className="p-4 text-right font-bold">{num(item.amount)}</td></>}
                                                            {activeTab === 'discounts' && <><td className="p-4 font-mono">{item.reg_no}</td><td className="p-4">{item.name}</td><td className="p-4 text-gray-500">{item.term}</td><td className="p-4 text-right font-bold text-purple-600">{item.discount}%</td></>}
                                                            {activeTab === 'users' && <><td className="p-4 font-bold">{item.username}</td><td className="p-4 capitalize">{item.role}</td><td className="p-4 text-xs max-w-xs truncate">{item.role === 'admin' ? 'Full Access' : (Array.isArray(item.permissions) ? item.permissions.join(', ') : item.permissions)}</td></>}
                                                            {activeTab === 'banks' && <><td className="p-4 font-bold">{item.name}</td><td className="p-4 font-mono text-gray-600">{item.account_no}</td></>}
                                                            <td className="p-4 text-center flex justify-center gap-2">
                                                                <button onClick={() => openModal(activeTab, item)} className="p-2 text-blue-600 hover:bg-blue-50 rounded"><i className="fas fa-edit"></i> Edit</button>
                                                                <button onClick={() => handleDelete(activeTab, item.id)} className="p-2 text-red-600 hover:bg-red-50 rounded"><Trash2 className="h-4 w-4" /></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {filteredData.length === 0 && <tr><td colSpan="10" className="p-8 text-center text-gray-400">No records found.</td></tr>}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* NEW: SESSION DETAIL MODAL WITH PRINT FIX */}
                    {sessionDetail && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 print:p-0 print:block print:relative">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col print:h-auto print:shadow-none print:w-full print:max-w-none">
                                {/* HEADER (No Print) */}
                                <div className="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl no-print">
                                    <h3 className="text-xl font-bold">Session Detail: {sessionDetail.session}</h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => window.print()} className="bg-gray-700 text-white px-4 py-2 rounded">Print</button>
                                        <button onClick={() => setSessionDetail(null)} className="text-2xl">&times;</button>
                                    </div>
                                </div>
                                
                                {/* PRINTABLE CONTENT */}
                                <div className="flex-1 overflow-auto p-6 print:overflow-visible print:p-0" id="printableArea">
                                    
                                    {/* UOL HEADER (Visible ONLY in Print) */}
                                    <div className="hidden print-only-header mb-4 border-b-2 border-gray-800 pb-4">
                                         <div className="flex justify-between items-start">
                                            <div className="w-32 h-32 rounded-lg flex items-center justify-center font-bold text-gray-400 overflow-hidden"><img src="src/UOL-Green-V1.png" alt="UOL Logo" className="w-full h-full object-contain" /></div>
                                            <div className="text-center flex-1 px-4">
                                                <h2 className="text-2xl font-bold text-gray-900 uppercase">The University of Lahore</h2>
                                                <p className="text-gray-600 font-medium">School of Accountancy & Finance</p>
                                                <div className="inline-block bg-gray-100 px-3 py-1 rounded mt-2 text-xs font-bold uppercase tracking-wider">Session Detail Report: {sessionDetail.session}</div>
                                                <div className="text-xs text-gray-500 mt-1">Generated: {new Date().toLocaleDateString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Summary Cards (HIDDEN IN PRINT per request) */}
                                    <div className="grid grid-cols-5 gap-4 mb-6 text-sm no-print">
                                        <div className="border p-2 rounded"><b>Enrolled:</b> {sessionDetail.enrolled}</div>
                                        <div className="border p-2 rounded"><b>Charged:</b> {num(sessionDetail.charged)}</div>
                                        <div className="border p-2 rounded"><b>Discount:</b> {num(sessionDetail.discount)}</div>
                                        <div className="border p-2 rounded"><b>Paid:</b> {num(sessionDetail.paid)}</div>
                                        <div className="border p-2 rounded bg-gray-100"><b>Balance:</b> {num(sessionDetail.balance)}</div>
                                    </div>

                                    <table className="w-full text-xs text-left border-collapse session-detail-table">
                                        <thead className="bg-gray-100 uppercase font-bold text-gray-700">
                                            <tr>
                                                <th className="p-2 border">#</th>
                                                <th className="p-2 border">Reg No</th>
                                                <th className="p-2 border">Name</th>
                                                <th className="p-2 border text-center">Courses</th>
                                                <th className="p-2 border text-center">Cr</th>
                                                <th className="p-2 border text-right">Tuition</th>
                                                <th className="p-2 border text-right">Exam Fee</th>
                                                <th className="p-2 border text-right">Discount</th>
                                                <th className="p-2 border text-right">Total</th>
                                                <th className="p-2 border text-right">Paid</th>
                                                <th className="p-2 border text-right">Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {sessionDetail.details.map((s, idx) => (
                                                <tr key={idx} className="border-b">
                                                    <td className="p-2 border">{idx + 1}</td>
                                                    <td className="p-2 border font-mono">{s.reg_no}</td>
                                                    <td className="p-2 border">{s.name}</td>
                                                    <td className="p-2 border text-center">{s.courses}</td>
                                                    <td className="p-2 border text-center">{s.cr}</td>
                                                    <td className="p-2 border text-right">{num(s.tuition)}</td>
                                                    <td className="p-2 border text-right">{num(s.exam)}</td>
                                                    <td className="p-2 border text-right text-red-500">{num(s.discount)}</td>
                                                    <td className="p-2 border text-right font-bold">{num(s.tuition + s.exam + s.other - s.discount)}</td>
                                                    <td className="p-2 border text-right text-green-700">{num(s.paid)}</td>
                                                    <td className="p-2 border text-right font-bold">{num(s.balance)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
